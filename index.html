<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Selfie Search ‚Äì FotoOwl style</title>
  <style>
    :root{
      --bg:#fff8f1;--panel:#ffffff;--text:#1e1b16;--muted:#6b7280;--line:#f1e6d8;
      --brand:#ff2c2c;       /* primary red like FotoOwl capture btn */
      --brand2:#ff6a6a;      /* lighter red */
      --ok:#16a34a;--okbg:#0f172a;--okring:#22c55e;
      --chip:#fff1e0;--shadow:0 8px 24px rgba(255,0,0,.18)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    body.modal-open{overflow:hidden}
    .wrap{max-width:1120px;margin-inline:auto;padding:18px}
    header{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .title{font-size:24px;font-weight:800;color:#111827}
    .subtitle{font-size:15px;color:#374151}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 14px rgba(0,0,0,.04)}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:920px){.row{grid-template-columns:1fr 1fr}}
    .h1{font-size:18px;margin:0 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#8b5a2b}
    input[type=text],select{width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--text);padding:12px 14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .05s ease, box-shadow .2s}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;box-shadow:var(--shadow)}
    .btn.ghost{background:#fff;color:#3b3b3b;border:1px solid var(--line)}
    .btn.bad{background:#ffe4e6;color:#9f1239;border:1px solid #fecdd3}
    .btn.ok{background:#dcfce7;color:#14532d;border:1px solid #bbf7d0}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .media{aspect-ratio:4/3;background:#fff;border:1px dashed var(--line);border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .media video,.media img{width:100%;height:100%;object-fit:cover}
    .note{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:10px}
    .tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;position:relative}
    .tile img{width:100%;height:220px;object-fit:cover;border-radius:10px}
    .sticky-bar{position:sticky;bottom:0;z-index:5;background:#fffbeccc;backdrop-filter:blur(6px);padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:12px}

    /* --- Selfie Modal (FotoOwl-like) --- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:none;z-index:40}
    .modal.show{display:grid;place-items:center}
    .modal-card{width:min(520px,92vw);background:#0f1115;border-radius:18px;color:#e5e7eb;box-shadow:0 25px 60px rgba(0,0,0,.55);padding:18px 18px 22px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal-title{font-weight:800;letter-spacing:.3px}
    .modal-close{background:transparent;border:0;color:#9ca3af;font-size:20px;cursor:pointer}

    .cam-wrap{position:relative;display:grid;place-items:center;margin:12px 0 10px}
    .cam{width:320px;height:320px;border-radius:999px;overflow:hidden;display:grid;place-items:center;background:#000}
    .cam video,.cam img{width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}

    /* circular mask ring + dotted progress like FotoOwl */
    .ring{position:absolute;width:340px;height:340px;border-radius:999px;pointer-events:none}
    .ring::before{content:"";position:absolute;inset:0;border-radius:999px;border:2px dashed rgba(255,255,255,.28);animation:spin 12s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* face mesh (decorative SVG) */
    .mesh{position:absolute;width:260px;height:260px;pointer-events:none;opacity:.85}

    .modal-actions{display:flex;justify-content:center;gap:10px;margin-top:10px}
    .btn.capture{background:var(--brand);color:#fff;border-radius:10px;padding:12px 18px}
    .btn.retake{background:#111827;color:#fff;border:1px solid #374151}
    .btn.done{background:#0ea5e9;color:#06243a}

    .verify{display:flex;align-items:center;gap:8px;font-weight:700;color:#a7f3d0;margin:6px 0}
    .verify .dot{width:10px;height:10px;border-radius:999px;background:var(--okring);box-shadow:0 0 0 6px rgba(34,197,94,.18)}

    /* small form styles (name/email/phone + consent) */
    .form{display:grid;gap:10px;margin-top:8px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{background:#111827;border:1px solid #374151;border-radius:10px;padding:10px;color:#e5e7eb}
    .consent{display:flex;gap:8px;align-items:flex-start;color:#cbd5e1;font-size:13px}
  </style>

  <!-- CONFIG (kept same as your file) -->
  <script>
    window.API = {
      BASE: "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search",
      LINK_ID: "3ff7e052ee37",
      DEFAULT_FOLDER: "common",
      THRESHOLD: 95,
      MAX_RESULTS: 200
    };
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</div>
      <div class="subtitle">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ï‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•á ‡§´‡•ã‡§ü‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</div>
    </header>

    <div class="row">
      <!-- Left: Camera / File pick -->
      <section class="card">
        <div class="h1">‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•á ‡§ï‡•à‡§™‡•ç‡§ö‡§∞</div>

        <div class="media" id="mediaBox">
          <video id="video" playsinline></video>
          <img id="preview" alt="preview" style="display:none" />
        </div>

        <div class="stack" style="margin:12px 0 8px">
          <button class="btn ghost" id="btnOpenModal">üì∑ Open Camera</button>
          <button class="btn ghost" id="btnStop" disabled>Stop</button>
        </div>

        <div id="fileRow" class="stack" style="margin-top:6px">
          <input type="file" id="file" accept="image/*" multiple />
          <span class="note">* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§™‡•â‡§™‚Äë‡§Ö‡§™ ‡§∏‡•á ‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§Ç</span>
        </div>
      </section>

      <!-- Right: Selected + Search -->
      <section class="card">
        <div class="stack" style="justify-content:space-between">
          <div class="h1">Selected Photo <span class="pill muted">latest</span></div>
          <span class="pill" id="folderInfo">folder: link</span>
        </div>

        <div class="media"><img id="selected" alt="selected" /></div>

        <div class="stack" style="margin:12px 0 6px">
          <button class="btn primary" id="btnSearch" disabled>Search</button>
          <button class="btn ghost" id="btnClear">Clear</button>
          <span class="pill" id="cfgInfo"></span>
        </div>

        <div class="note">API:
          <input id="apiField" type="text" readonly />
        </div>
      </section>
    </div>

    <!-- Results -->
    <section class="card" style="margin-top:16px">
      <div class="h1">Results</div>
      <div class="stack" style="align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="stack">
          <label class="pill">Page size
            <select id="pageSize" style="width:auto;margin-left:8px">
              <option>12</option><option selected>24</option><option>48</option><option>96</option>
            </select>
          </label>
          <span id="countBadge" class="pill">0</span>
        </div>
        <div class="stack">
          <button class="btn ghost" id="btnPrev" disabled>‚óÄÔ∏é Prev</button>
          <span class="pill" id="pageBadge">1 / 1</span>
          <button class="btn ghost" id="btnNext" disabled>Next ‚ñ∂Ô∏é</button>
        </div>
      </div>
      <div id="msg" class="note">No search yet.</div>
      <div id="results" class="grid" style="display:none"></div>
      <div class="sticky-bar stack" style="justify-content:space-between;margin-top:12px">
        <div class="stack">
          <button class="btn ghost" id="btnSelectAll">Select all in page</button>
          <button class="btn ghost" id="btnUnselectAll">Unselect</button>
        </div>
        <div class="stack">
          <button class="btn ok" id="btnDownloadSel" disabled>Download selected</button>
          <button class="btn bad" id="btnClearSel" disabled>Clear selection</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Selfie Modal -->
  <div id="selfieModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Capture Selfie</div>
        <button class="modal-close" id="modalClose">‚úï</button>
      </div>

      <div class="cam-wrap">
        <div class="ring"></div>
        <div class="cam">
          <video id="mVideo" playsinline></video>
          <img id="mPreview" alt="selfie" style="display:none" />
        </div>
        <!-- decorative mesh (SVG) -->
        <svg class="mesh" viewBox="0 0 100 100" aria-hidden="true">
          <g fill="none" stroke="rgba(255,200,0,.9)" stroke-width=".6">
            <polygon points="20,30 50,15 80,30 85,55 50,90 15,55"/>
            <polyline points="20,30 50,50 80,30"/>
            <polyline points="15,55 50,70 85,55"/>
            <polyline points="50,15 50,70 50,90"/>
          </g>
        </svg>
      </div>

      <div id="captureHint" class="note" style="text-align:center;margin-top:2px">Keep face in the center and press Capture</div>
      <div id="verifyBar" class="verify" style="display:none"><span class="dot"></span> Selfie Verified</div>

      <div class="modal-actions" id="captureBtns">
        <button class="btn capture" id="btnCapture">üì∏ Capture</button>
      </div>
      <div class="modal-actions" id="verifyBtns" style="display:none">
        <button class="btn retake" id="btnRetake">Retake</button>
        <button class="btn ok" id="btnDone">‚úì Done</button>
      </div>

      <div class="form" style="margin-top:12px">
        <div class="row2">
          <input class="field" id="fName" placeholder="Name"/>
          <input class="field" id="fEmail" placeholder="Email"/>
        </div>
        <input class="field" id="fPhone" placeholder="Mobile Number"/>
        <label class="consent"><input type="checkbox" id="fConsent"/> <span>I Agree to the Privacy Policy and give my Consent</span></label>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Config ---------- */
    const qs = new URLSearchParams(location.search);
    const BASE = (qs.get("base") || (window.API && window.API.BASE) || "").replace(/\/$/, "");
    const LINK_ID = qs.get("link") || (window.API && window.API.LINK_ID) || "";
    const DEFAULT_FOLDER = qs.get("folder") || (window.API && window.API.DEFAULT_FOLDER) || "common";
    const THRESHOLD = Number(qs.get("threshold")) || (window.API && window.API.THRESHOLD) || 50;
    const MAX_RESULTS = Number(qs.get("max")) || (window.API && window.API.MAX_RESULTS) || 200;

    /* ---------- DOM ---------- */
    const selected = document.getElementById('selected');
    const file = document.getElementById('file');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear  = document.getElementById('btnClear');
    const apiField  = document.getElementById('apiField');
    const cfgInfo   = document.getElementById('cfgInfo');
    const folderInfo= document.getElementById('folderInfo');
    const msg       = document.getElementById('msg');
    const resultsEl = document.getElementById('results');
    const pageSizeSel = document.getElementById('pageSize');
    const pageBadge = document.getElementById('pageBadge');
    const countBadge = document.getElementById('countBadge');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnUnselectAll = document.getElementById('btnUnselectAll');
    const btnDownloadSel = document.getElementById('btnDownloadSel');
    const btnClearSel = document.getElementById('btnClearSel');

    // Modal elements
    const modal = document.getElementById('selfieModal');
    const modalClose = document.getElementById('modalClose');
    const btnOpenModal = document.getElementById('btnOpenModal');
    const mVideo = document.getElementById('mVideo');
    const mPreview = document.getElementById('mPreview');
    const btnCapture = document.getElementById('btnCapture');
    const btnRetake = document.getElementById('btnRetake');
    const btnDone = document.getElementById('btnDone');
    const verifyBar = document.getElementById('verifyBar');
    const captureBtns = document.getElementById('captureBtns');
    const verifyBtns = document.getElementById('verifyBtns');

    apiField.value = BASE || "(missing)";
    cfgInfo.textContent = LINK_ID ? `linkId: ${LINK_ID}, max=${MAX_RESULTS}` : `folder: ${DEFAULT_FOLDER}, max=${MAX_RESULTS}`;
    folderInfo.textContent = LINK_ID ? "folder: link" : `folder: ${DEFAULT_FOLDER}`;

    let currentDataUrl = "";  // sent to search

    function setSelected(dataUrl){
      currentDataUrl = dataUrl || "";
      selected.src = dataUrl || "";
      btnSearch.disabled = !dataUrl || !BASE;
    }

    function toDataURLFromFile(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);}); }

    // Desktop file input
    if (file){ file.onchange = async (ev)=>{ const f=ev.target.files?.[0]; if(!f) return; setSelected(await toDataURLFromFile(f)); }; }
    btnClear.onclick = ()=> setSelected("");

    /* ---------- Selfie Modal Logic (FotoOwl style) ---------- */
    let stream = null;
    async function startModalCam(){
      if(stream) return; try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:false });
        mVideo.srcObject = stream; mVideo.onloadedmetadata=()=> mVideo.play();
      }catch(err){ alert('Camera not available. Please allow permission.'); }
    }
    function stopModalCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }

    function openModal(){ modal.classList.add('show'); document.body.classList.add('modal-open'); mPreview.style.display='none'; mVideo.style.display='block'; verifyBar.style.display='none'; verifyBtns.style.display='none'; captureBtns.style.display='flex'; startModalCam(); }
    function closeModal(){ modal.classList.remove('show'); document.body.classList.remove('modal-open'); stopModalCam(); }

    btnOpenModal.onclick = openModal; modalClose.onclick = closeModal; modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

    btnCapture.onclick = ()=>{
      if (!mVideo.videoWidth) return;
      const c=document.createElement('canvas'); c.width=mVideo.videoWidth; c.height=mVideo.videoHeight;
      c.getContext('2d').drawImage(mVideo,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.92);
      mPreview.src=dataUrl; mPreview.style.display='block'; mVideo.style.display='none';
      verifyBar.style.display='flex'; captureBtns.style.display='none'; verifyBtns.style.display='flex';
    };

    btnRetake.onclick = ()=>{
      mPreview.style.display='none'; mVideo.style.display='block';
      verifyBar.style.display='none'; captureBtns.style.display='flex'; verifyBtns.style.display='none';
    };

    btnDone.onclick = ()=>{ setSelected(mPreview.src); closeModal(); };

    /* ---------- Search + Pagination ---------- */
    let allResults = []; let currentPage = 1;
    function pageSize(){ return Number(pageSizeSel.value)||24; }

    function updatePager(){
      const total = allResults.length; const ps = pageSize(); const totalPages = Math.max(1, Math.ceil(total / ps));
      if (currentPage > totalPages) currentPage = totalPages;
      pageBadge.textContent = `${currentPage} / ${totalPages}`; countBadge.textContent = `${total} results`;
      btnPrev.disabled = (currentPage<=1); btnNext.disabled = (currentPage>=totalPages);
      const anySel = document.querySelectorAll('.tile input[type=checkbox]:checked').length>0; btnDownloadSel.disabled = !anySel; btnClearSel.disabled = !anySel;
    }

    function renderPage(){
      const ps = pageSize(); const start = (currentPage-1)*ps; const slice = allResults.slice(start, start+ps);
      resultsEl.innerHTML = slice.map((x,i)=>`<div class="tile" data-idx="${start+i}"><input type="checkbox" aria-label="select image"/><img src="${x.downloadUrl||''}" alt="match"/></div>`).join("");
      resultsEl.style.display = slice.length ? "" : "none";
      resultsEl.querySelectorAll('.tile input[type=checkbox]').forEach(cb=> cb.addEventListener('change',updatePager));
      updatePager();
    }

    document.getElementById('btnPrev').onclick = ()=>{ currentPage--; renderPage(); };
    document.getElementById('btnNext').onclick = ()=>{ currentPage++; renderPage(); };
    pageSizeSel.onchange = ()=>{ currentPage=1; renderPage(); };

    document.getElementById('btnSelectAll').onclick = ()=>{ resultsEl.querySelectorAll('.tile input[type=checkbox]').forEach(cb=>{ cb.checked=true; cb.dispatchEvent(new Event('change')); }); };
    document.getElementById('btnUnselectAll').onclick = ()=>{ resultsEl.querySelectorAll('.tile input[type=checkbox]').forEach(cb=>{ cb.checked=false; cb.dispatchEvent(new Event('change')); }); };
    document.getElementById('btnClearSel').onclick = document.getElementById('btnUnselectAll').onclick;

    async function forceDownload(url){ const resp = await fetch(url,{mode:'cors'}); const blob = await resp.blob(); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (new URL(url)).pathname.split('/').pop()||'photo.jpg'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50); }
    document.getElementById('btnDownloadSel').onclick = async ()=>{ const selectedUrls = [...resultsEl.querySelectorAll('.tile input:checked')].map(cb=>{ const idx = Number(cb.closest('.tile').dataset.idx); return allResults[idx]?.downloadUrl; }).filter(Boolean); for (const url of selectedUrls){ try{ await forceDownload(url); }catch(e){ console.warn('download failed', url, e); } } };

    document.getElementById('btnSearch').onclick = async ()=>{
      if (!currentDataUrl){ alert('Pick/Capture a photo first.'); return; }
      if (!BASE){ alert('API BASE is missing.'); return; }
      msg.textContent = 'Searching...'; resultsEl.style.display='none'; resultsEl.innerHTML='';
      const body = { imageBase64: currentDataUrl, threshold: THRESHOLD, maxResults: MAX_RESULTS };
      if (LINK_ID) body.linkId = LINK_ID; else body.allowedFolders = [DEFAULT_FOLDER];
      try{
        const r = await fetch(`${BASE}/search`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j = await r.json().catch(()=> ({}));
        if (!r.ok){ msg.innerHTML = `<div class="note" style="color:#ef4444">Server Error (${r.status}).</div>`; console.warn(j); return; }
        if (!j || !Array.isArray(j.results)){ msg.innerHTML = `<div class="note" style="color:#ef4444">Unexpected response.</div>`; console.warn(j); return; }
        allResults = j.results || [];
        if (j.count && j.count > allResults.length){ msg.innerHTML = `<div class=\"note\" style=\"color:#16a34a\">Found: ${j.count}. Showing: ${allResults.length}. Need more? add <b>?max=500</b> in URL.</div>`; }
        else { msg.innerHTML = `<div class=\"note\" style=\"color:#16a34a\">${allResults.length} matches.</div>`; }
        currentPage = 1; renderPage();
      }catch(err){ console.error(err); msg.innerHTML = `<div class=\"note\" style=\"color:#ef4444\">Network/JSON error.</div>`; }
    };

    // init
    (function(){ selected.src=""; })();
  </script>
</body>
</html>
