<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी – मंदसौर | Selfie Search</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1629; --muted:#9bb0d3; --text:#e9eefc;
      --brand:#ff7a00; --brand-2:#ff9c40; --danger:#ff5757;
      --chip:#1a2442; --chip2:#0f1b36; --ok:#2ecc71;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header .logo{width:32px;height:32px;border-radius:6px;background:var(--brand)}
    header h1{font-size:18px;margin:0}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1a2544;border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--brand);border:0;color:#1b1002;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.alt{background:#233257;color:var(--text)}
    .btn.ghost{background:transparent;border:1px solid #2b3f71;color:var(--text)}
    .btn.small{padding:7px 10px;font-weight:600}
    input[type="file"]{display:block;color:var(--muted)}
    input.text{width:100%;background:#0b1430;border:1px solid #21345e;color:var(--text);padding:10px 12px;border-radius:10px}
    .hint{color:var(--muted);font-size:13px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #21345e;padding:4px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .preview{width:100%;aspect-ratio:4/5;background:#000;border-radius:10px;object-fit:contain;border:1px dashed #2b3f71}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
    .thumb{background:#0c142b;border:1px solid #223663;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;height:160px;object-fit:cover;display:block}
    .thumb .meta{padding:6px 8px;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}
    .err{color:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>भारतीय जनता पार्टी – मंदसौर</h1>
      <div style="margin-left:auto" class="hint">Selfie Search</div>
    </header>

    <!-- =========== CONFIG (इसे भरें) =========== -->
    <script>
      window.API = {
        // 1) आपका API base (must end WITHOUT trailing slash)
        BASE: "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search",

        // 2) Optional स्थायी Link ID (admin generate-link से) — खाली छोड़ें तो URL ?link= से पढ़ेगा
        LINK_ID: "3ff7e052ee37", // उदाहरण: "3ff7e052ee37"

        // 3) Default folder (जब LINK_ID खाली हो)
        DEFAULT_FOLDER: "common",

        // 4) Defaults
        THRESHOLD: 60,
        MAX_RESULTS: 20
      };
    </script>

    <!-- =========== MAIN UI =========== -->
    <div class="grid">
      <!-- Left: Camera / upload -->
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <input id="name" class="text" placeholder="आपका नाम" />
          <input id="mobile" class="text" placeholder="मोबाइल" inputmode="numeric" />
          <span class="hint">* केवल रजिस्ट्रेशन हेतु</span>
        </div>

        <h3 style="margin:6px 0 10px">फोटो चुनें या कैमरा से कैप्चर करें</h3>
        <video id="video" class="preview" autoplay playsinline muted style="display:none"></video>
        <img id="preview" class="preview" alt="preview"/>

        <div class="row" style="margin:10px 0">
          <button id="startCam" class="btn small">कैमरा चालू करें</button>
          <button id="snap" class="btn small alt">कैप्चर करें</button>
          <button id="stopCam" class="btn small ghost">बंद करें</button>
        </div>

        <div class="row" style="margin:6px 0 10px">
          <input id="file" type="file" accept="image/jpeg,image/png,image/webp" />
        </div>
        <div class="hint">* अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।</div>
      </div>

      <!-- Right: Selected & Search -->
      <div class="card">
        <h3 style="margin:6px 0 10px">चुना गया फोटो <span class="hint">(latest)</span></h3>
        <img id="picked" class="preview" alt="selected"/>

        <div class="row" style="margin:10px 0 6px">
          <button id="doSearch" class="btn">सर्च करें</button>
          <button id="clear" class="btn alt">हटाएँ</button>
          <span class="chip" id="folderChip">folder: <b id="folderName">link</b></span>
        </div>

        <div class="row hint">
          <span>API: <span id="apiChip" class="chip">loading…</span></span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="card" style="margin-top:14px">
      <h3 style="margin:6px 0 10px">रिज़ल्ट</h3>
      <div id="msg" class="hint">कोई मिलान नहीं मिला।</div>
      <div id="results" class="results"></div>
      <div class="row" style="margin-top:10px">
        <button id="more" class="btn alt small" style="display:none">और दिखाएँ</button>
      </div>
    </div>
  </div>

  <!-- =========== MAIN SCRIPT =========== -->
  <script>
  // ---- Read config + URL overrides
  const qs = new URLSearchParams(location.search);

  // Clean base (remove trailing /)
  const BASE = (qs.get("base") || (window.API && window.API.BASE) || "").replace(/\/$/, "");

  // pick linkId (sanitize – सिर्फ़ अल्फ़ा-न्यूमेरिक)
  const rawLink = qs.get("link") || (window.API && window.API.LINK_ID) || "";
  const LINK_ID = (rawLink || "").toString().trim().match(/[A-Za-z0-9]{8,16}/)?.[0] || "";

  // default folder (जब linkId खाली)
  const DEFAULT_FOLDER = (qs.get("folder") || (window.API && window.API.DEFAULT_FOLDER) || "common").trim();

  const THRESHOLD = Number(qs.get("threshold")) || (window.API && window.API.THRESHOLD) || 60;
  const MAX_RESULTS = Number(qs.get("max")) || (window.API && window.API.MAX_RESULTS) || 20;

  // sanity
  const apiChip = document.getElementById("apiChip");
  if (!BASE) {
    apiChip.textContent = "API BASE कॉन्फ़िग नहीं है";
    apiChip.classList.add("err");
  } else {
    apiChip.textContent = BASE;
  }

  // ---- DOM refs
  const video = document.getElementById("video");
  const preview = document.getElementById("preview");
  const picked  = document.getElementById("picked");
  const fileInp = document.getElementById("file");
  const startCam = document.getElementById("startCam");
  const stopCam = document.getElementById("stopCam");
  const snap = document.getElementById("snap");
  const btnSearch = document.getElementById("doSearch");
  const btnClear  = document.getElementById("clear");
  const folderChip = document.getElementById("folderChip");
  const folderName = document.getElementById("folderName");
  const resultsBox = document.getElementById("results");
  const msg = document.getElementById("msg");
  const btnMore = document.getElementById("more");

  // folder chip info
  folderName.textContent = LINK_ID ? "link" : DEFAULT_FOLDER;

  // ---- Camera
  let stream=null;
  startCam.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }});
      video.srcObject = stream;
      video.style.display="";
      preview.style.display="none";
    } catch (e) {
      alert("कैमरा चालू नहीं हो पाया। ब्राउज़र/डिवाइस अनुमति दें।");
      console.error(e);
    }
  };
  stopCam.onclick = () => {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.style.display="none";
    preview.style.display="";
  };
  snap.onclick = () => {
    if(!video.srcObject) { alert("पहले कैमरा चालू करें."); return; }
    const c=document.createElement("canvas");
    c.width=video.videoWidth||720; c.height=video.videoHeight||900;
    c.getContext("2d").drawImage(video,0,0,c.width,c.height);
    picked.src = c.toDataURL("image/jpeg",0.92);
    msg.textContent=""; resultsBox.innerHTML="";
  };

  // ---- File select
  fileInp.onchange = async (ev)=>{
    const f=ev.target.files?.[0]; if(!f) return;
    picked.src = await fileToDataURL(f);
    msg.textContent=""; resultsBox.innerHTML="";
  };

  function fileToDataURL(f) {
    return new Promise((res, rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej; r.readAsDataURL(f);
    });
  }

  // ---- Search
  btnSearch.onclick = async () => {
    try{
      const dataURL = picked.src;
      if(!dataURL || !/^data:image\//.test(dataURL)){
        alert("कृपया फोटो चुनें/कैप्चर करें।"); return;
      }
      if(!BASE){ alert("API BASE कॉन्फ़िग नहीं है."); return; }

      // body: या तो linkId या allowedFolders
      const body = {
        imageBase64: dataURL,
        threshold: THRESHOLD,
        maxResults: MAX_RESULTS
      };
      if(LINK_ID){
        body.linkId = LINK_ID;
      } else {
        body.allowedFolders = [DEFAULT_FOLDER];
      }

      const r = await fetch(`${BASE}/search`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const tx = await r.text().catch(()=>r.statusText);
        throw new Error(`HTTP ${r.status}: ${tx}`);
      }
      const j = await r.json();
      renderResults(j);
    }catch(err){
      console.error(err);
      msg.innerHTML = `<span class="err">Error: ${err.message}</span>`;
    }
  };

  btnClear.onclick = ()=>{
    picked.src=""; resultsBox.innerHTML=""; msg.textContent=""; fileInp.value="";
  };

  // ---- Render results (simple)
  function renderResults(j){
    const arr = j?.results || [];
    resultsBox.innerHTML="";
    if(!arr.length){ msg.textContent="कोई मिलान नहीं मिला।"; btnMore.style.display="none"; return; }
    msg.textContent = `${j.count||arr.length} परिणाम मिले`;
    arr.forEach(item=>{
      const el=document.createElement("div");
      el.className="thumb";
      const img=document.createElement("img");
      // pre-signed url दी है; सीधे दिखाइए
      img.src=item.downloadUrl || "#";
      const meta=document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `<b class="ok">${Math.round(item.similarity||0)}%</b> • <span class="hint">${item.key||""}</span>`;
      el.appendChild(img); el.appendChild(meta);
      resultsBox.appendChild(el);
    });
    btnMore.style.display="none"; // server pagination न हो तो छुपाएँ
  }

  // Initial previews hidden
  preview.style.display="";
  picked.src="";
  </script>
</body>
</html>
