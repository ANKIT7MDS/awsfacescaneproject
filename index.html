<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी – मंदसौर | Selfie Search</title>
  <meta name="theme-color" content="#f97316" />
  <style>
    :root{
      --orange:#f97316; --orange-600:#ea580c; --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --white:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb;}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    /* header */
    .bar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:#0f172a;border-bottom:1px solid rgba(148,163,184,.15);position:sticky;top:0;z-index:20}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .brand img{width:28px;height:28px;display:block}
    .tag{margin-left:auto;opacity:.75}
    /* cards & layout */
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:960px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{background:#0f172a;border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:16px}
    .title{font-weight:700;font-size:20px;margin:0 0 12px}
    .muted{color:#94a3b8}
    /* inputs */
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
    .in{flex:1;min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.2);background:#0b1326;color:#e5e7eb;outline:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(249,115,22,.12);color:#f97316;border:1px solid rgba(249,115,22,.35);font-size:12px}
    /* buttons */
    .btn{appearance:none;border:0;background:var(--orange);color:#000;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.sec{background:#1f2937;color:#e5e7eb}
    .btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.25);color:#e5e7eb}
    /* camera / preview */
    .camWrap{position:relative;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(148,163,184,.2)}
    video,canvas{width:100%;height:100%;object-fit:cover;display:block}
    .preview{width:200px;border-radius:12px;border:1px solid rgba(148,163,184,.25)}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    /* results */
    .results{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px}
    @media(min-width:640px){ .results{grid-template-columns:repeat(3,1fr)} }
    .res{background:#0f172a;border:1px solid rgba(148,163,184,.2);border-radius:12px;overflow:hidden}
    .res img{width:100%;display:block}
    .res .meta{padding:8px;font-size:12px;color:#94a3b8}
    .center{display:flex;justify-content:center;margin-top:10px}
    /* small helper */
    .note{font-size:12px;color:#94a3b8;margin-top:6px}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="bar">
    <!-- inline BJP lotus (base64) to avoid external 404/CORS -->
    <img alt="BJP" src="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjRjk3MzE2IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMUM3LjU5IDEgNS4wNSA0LjI1IDUuMDUgNy41YzAgMi4zNiAxLjQ5IDQuNDMgMy41NSA1LjMyVjIxSDExdi0yLjE4YzIuMDYtLjg5IDMuNTUtMi45NiAzLjU1LTUuMzJDNzkuOTEgNC4yNSA2LjQxIDEgMTIgMXptMCAyYzIuOTQgMCA0Ljk1IDIuMjIgNC45NSA0LjVTMTRuLjUgNC45NSAyLjUyIDQuOTUgMi41MiAyLjIyIDQgMjAgMTR6Ii8+PC9zdmc+" />
    <div class="brand">भारतीय जनता पार्टी – मंदसौर</div>
    <div class="tag">Selfie Search</div>
  </div>

  <div class="container">
    <!-- Lead form -->
    <div class="row">
      <input class="in" id="leadName" placeholder="आपका नाम" />
      <input class="in" id="leadMobile" placeholder="मोबाइल" />
      <div class="badge">* केवल रजिस्ट्रेशन हेतु</div>
    </div>

    <div class="grid">
      <!-- Left: camera & uploader -->
      <div class="card">
        <h3 class="title">फोटो चुनें या कैमरा से कैप्चर करें</h3>
        <div class="camWrap" id="camBox">
          <video id="video" playsinline muted></video>
          <!-- canvas only for capture (not shown) -->
          <canvas id="canvas" style="display:none"></canvas>
        </div>
        <div class="actions">
          <button class="btn" id="btnStart">कैमरा चालू करें</button>
          <button class="btn sec" id="btnShot">कैप्चर करें</button>
          <button class="btn ghost" id="btnStop">बंद करें</button>
        </div>

        <div class="actions">
          <label class="btn">
            <input type="file" id="filePick" accept="image/*" multiple style="display:none" />
            एक या ज़्यादा फोटो चुनें (JPEG/PNG/WebP)
          </label>
        </div>
        <div class="note">* अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।</div>
      </div>

      <!-- Right: single preview + controls -->
      <div class="card">
        <h3 class="title">चुना गया फोटो <span class="muted">(latest)</span></h3>
        <img id="preview" class="preview" alt="preview" style="display:none" />
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btnSearch">सर्च करें</button>
          <button class="btn sec" id="btnClear">हटाएँ</button>
        </div>
        <div class="note">
          Folder: <span class="badge" id="folderBadge">common</span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="card" style="margin-top:16px">
      <h3 class="title">रिज़ल्ट</h3>
      <div id="nores" class="muted">कोई मिलान नहीं मिला।</div>
      <div id="results" class="results"></div>
      <div class="center"><button class="btn ghost" id="btnMore" style="display:none">और दिखाएँ</button></div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
  // यहां अपना permanent linkId डालें:
const FORCED_COMMON_LINK = "YOUR_PERMANENT_LINK_ID_HERE";  // ← इसे भरें

const LINK_ID = new URLSearchParams(location.search).get("link") || FORCED_COMMON_LINK;
const DEFAULT_FOLDER = "common";


    /* ====== DOM ====== */
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");
    const btnShot  = document.getElementById("btnShot");
    const btnSearch= document.getElementById("btnSearch");
    const btnClear = document.getElementById("btnClear");
    const filePick = document.getElementById("filePick");
    const folderBadge = document.getElementById("folderBadge");
    const resultsEl = document.getElementById("results");
    const noresEl = document.getElementById("nores");
    const btnMore = document.getElementById("btnMore");

    folderBadge.textContent = DEFAULT_FOLDER;

    let stream = null;
    let activeDataUrl = ""; // latest chosen image (camera/file) – यही search में जाएगा
    let page = 0; // see more के लिए (client side slicing)

    /* ====== CAMERA ====== */
    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }, audio:false });
        video.srcObject = stream;
        await video.play();
      }catch(e){
        alert("कैमरा चालू नहीं हो पाया। ब्राउज़र/डिवाइस अनुमति दें।");
      }
    }
    function stopCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
      }
      video.srcObject=null;
    }
    function capture(){
      if(!video.videoWidth){ alert("वीडियो तैयार नहीं है"); return; }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      activeDataUrl = canvas.toDataURL("image/jpeg",0.92);
      showPreview(activeDataUrl);
    }

    /* ====== FILE PICK ====== */
    filePick.addEventListener("change", async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const rdr = new FileReader();
      rdr.onload = ()=>{ activeDataUrl = rdr.result; showPreview(activeDataUrl); };
      rdr.readAsDataURL(f);
    });

    /* ====== PREVIEW / RESET ====== */
    function showPreview(url){
      preview.src = url; preview.style.display = "block";
    }
    function clearPreview(){
      preview.removeAttribute("src");
      preview.style.display="none";
      activeDataUrl="";
      resultsEl.innerHTML="";
      noresEl.style.display="block";
      btnMore.style.display="none";
      page=0;
    }

    /* ====== SEARCH ====== */
    async function doSearch(){
      if(!activeDataUrl){ alert("कृपया पहले फोटो चुनें/कैप्चर करें!"); return; }
      // payload: अगर LINK_ID है तो उसे भेजें; वरना allowedFolders=["common"]
      const body = LINK_ID
        ? { imageBase64: activeDataUrl, linkId: LINK_ID, threshold: 65, maxResults: 100 }
        : { imageBase64: activeDataUrl, allowedFolders: [DEFAULT_FOLDER], threshold: 65, maxResults: 100 };

      const r = await fetch(`${BASE}/search`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text().catch(()=>r.statusText);
        alert(`सर्च में त्रुटि: ${r.status} ${txt}`);
        return;
      }
      const json = await r.json();
      renderResults(json);
    }

    function renderResults(resp){
      resultsEl.innerHTML="";
      const arr = (resp?.results || []);
      if(!arr.length){
        noresEl.style.display="block"; btnMore.style.display="none"; return;
      }
      noresEl.style.display="none";
      // client-side “और दिखाएँ”
      const chunk = 12;
      const slice = arr.slice(page*chunk,(page+1)*chunk);
      slice.forEach(x=>{
        const d = document.createElement("div");
        d.className="res";
        d.innerHTML = `
          <img loading="lazy" src="${x.downloadUrl}" alt="match" />
          <div class="meta">similarity: ${Math.round(x.similarity||0)} • ${x.key||""}</div>
        `;
        resultsEl.appendChild(d);
      });
      page++;
      btnMore.style.display = (arr.length>page*chunk) ? "inline-flex" : "none";
      btnMore.onclick = ()=> renderResults({results:resp.results});
    }

    /* ====== EVENTS ====== */
    btnStart.onclick = startCamera;
    btnStop.onclick  = stopCamera;
    btnShot.onclick  = capture;
    btnSearch.onclick= doSearch;
    btnClear.onclick = clearPreview;

    // अगर आप चाहें: load पर autofocus
    // document.getElementById("leadName").focus();
  </script>
</body>
</html>
