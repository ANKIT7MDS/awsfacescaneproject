import React, { useEffect, useMemo, useRef, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Camera, Download, ImagePlus, Loader2, Search } from "lucide-react";
import JSZip from "jszip";

/**
 * 🔶 Selfie Search – BJP Mandsaur Theme
 * -------------------------------------------------------------
 * - Orange theme, Hindi labels
 * - Name + Mobile inputs (for lead capture – optional)
 * - Camera capture + File select (multiple)
 * - Preview thumbnails (tap/ click to select)
 * - Search by selfie (via POST /search)
 * - Bulk download selected results (zip)
 * - "See more" pagination (client-side)
 * - Mobile-first, responsive, clean
 *
 * HOW TO USE
 * 1) Set BASE and (optionally) LINK_ID below; OR pass through URL as:
 *    https://your-site/?link=379de0d73551
 * 2) If no link is present, we default to folderId="common" for search.
 * 3) Deploy to Netlify.
 */

const BASE = import.meta.env.VITE_API_BASE || "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search"; // API Gateway base

export default function SelfieSearchBJP() {
  // ───────────────────────────────────────────────────────────────────────
  // URL params & defaults
  const url = new URL(window.location.href);
  const LINK_ID = url.searchParams.get("link") || ""; // sharable link id
  const DEFAULT_FOLDER = "common"; // fallback when link is not provided

  // ───────────────────────────────────────────────────────────────────────
  // Lead capture (optional)
  const [name, setName] = useState("");
  const [mobile, setMobile] = useState("");

  // ───────────────────────────────────────────────────────────────────────
  // Image selection & camera capture
  const [files, setFiles] = useState([]); // File[]
  const [activeIdx, setActiveIdx] = useState(0);
  const [capturing, setCapturing] = useState(false);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  const startCamera = async () => {
    try {
      setCapturing(true);
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        streamRef.current = stream;
        await videoRef.current.play();
      }
    } catch (e) {
      console.error(e);
      alert("कैमरा चालू नहीं हो पाया। ब्राउज़र/डिवाइस अनुमति दें।");
      setCapturing(false);
    }
  };

  const captureFrame = () => {
    const video = videoRef.current;
    if (!video) return;
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob((blob) => {
      if (!blob) return;
      const file = new File([blob], `selfie_${Date.now()}.jpg`, { type: "image/jpeg" });
      setFiles((prev) => [file, ...prev]);
      stopCamera();
    }, "image/jpeg", 0.92);
  };

  const stopCamera = () => {
    setCapturing(false);
    if (streamRef.current) {
      for (const track of streamRef.current.getTracks()) track.stop();
      streamRef.current = null;
    }
  };

  const onPick = (ev) => {
    const sel = Array.from(ev.target.files || []);
    if (sel.length) setFiles((prev) => [...sel, ...prev]);
    ev.target.value = "";
  };

  const removeFile = (idx) => setFiles((prev) => prev.filter((_, i) => i !== idx));

  // ───────────────────────────────────────────────────────────────────────
  // Search
  const [busy, setBusy] = useState(false);
  const [results, setResults] = useState([]); // API results
  const [showCount, setShowCount] = useState(12);

  const activeFile = useMemo(() => files[activeIdx], [files, activeIdx]);

  const fileToDataUrl = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

  const search = async () => {
    if (!activeFile) {
      alert("कृपया एक फोटो चुनें या कैमरा से क्लिक करें।");
      return;
    }
    setBusy(true);
    try {
      const dataUrl = await fileToDataUrl(activeFile);
      const body = {
        imageBase64: dataUrl,
        // अगर sharable link है तो backend उसी के allowedFolders यूज़ करेगा; नहीं है तो fallback
        linkId: LINK_ID || undefined,
        allowedFolders: LINK_ID ? undefined : [DEFAULT_FOLDER],
        threshold: 62,
        maxResults: 100,
      };

      const r = await fetch(`${BASE}/search`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!r.ok) throw new Error(`Search failed ${r.status}`);
      const json = await r.json();
      const list = (json.results || []).map((x, i) => ({
        id: `${x.key}-${i}`,
        similarity: x.similarity,
        url: x.downloadUrl || x.url || x.s3 || "",
        key: x.key,
        folderId: x.folderId,
        checked: false,
      }));
      setResults(list);
      setShowCount(12);
    } catch (e) {
      console.error(e);
      alert("सर्च में समस्या आई। बाद में पुनः प्रयास करें।");
    } finally {
      setBusy(false);
    }
  };

  const toggleCheck = (id) => setResults((prev) => prev.map((r) => (r.id === id ? { ...r, checked: !r.checked } : r)));

  const visible = useMemo(() => results.slice(0, showCount), [results, showCount]);

  const downloadSelected = async () => {
    const sel = results.filter((r) => r.checked && r.url);
    if (!sel.length) return alert("कृपया डाउनलोड के लिए कुछ फोटो चुनें।");
    const zip = new JSZip();
    for (const item of sel) {
      const res = await fetch(item.url);
      const blob = await res.blob();
      const fname = item.key?.split("/").pop() || `photo_${Math.random().toString(36).slice(2)}.jpg`;
      zip.file(fname, blob);
    }
    const out = await zip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(out);
    a.download = `selected_${Date.now()}.zip`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // ───────────────────────────────────────────────────────────────────────
  // UI
  return (
    <div className="min-h-screen bg-orange-50 text-zinc-900">
      {/* Header */}
      <header className="sticky top-0 z-30 bg-orange-600 text-white shadow-md">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0e/Bharatiya_Janata_Party_logo.svg" alt="BJP" className="w-9 h-9"/>
            <div>
              <div className="text-lg md:text-2xl font-bold leading-tight">भारतीय जनता पार्टी – मंदसौर</div>
              <div className="text-xs md:text-sm opacity-90">अपना फोटो खोजें – Selfie Search</div>
            </div>
          </div>
          <div className="hidden md:flex items-center gap-2">
            <Button className="bg-white text-orange-600 hover:bg-orange-100">Help</Button>
          </div>
        </div>
      </header>

      {/* Lead form */}
      <div className="max-w-6xl mx-auto px-4 mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
        <Input value={name} onChange={(e)=>setName(e.target.value)} placeholder="नाम" className="bg-white" />
        <Input value={mobile} onChange={(e)=>setMobile(e.target.value)} placeholder="मोबाइल" className="bg-white" />
        <div className="col-span-1 md:col-span-2 text-sm text-zinc-600 flex items-center">(वैकल्पिक) केवल रजिस्ट्रेशन हेतु</div>
      </div>

      {/* Capture / Select */}
      <section className="max-w-6xl mx-auto px-4 mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* Left: capture */}
        <Card className="md:col-span-1">
          <CardContent className="p-4 space-y-3">
            <div className="font-semibold">अपना फोटो चुनें</div>
            {!capturing ? (
              <div className="flex gap-2">
                <Button onClick={startCamera} className="bg-orange-600 hover:bg-orange-700"><Camera className="mr-2 h-4 w-4"/> कैमरा चालू करें</Button>
                <label className="inline-flex items-center gap-2 bg-orange-100 text-orange-700 px-3 py-2 rounded-xl cursor-pointer hover:bg-orange-200">
                  <ImagePlus className="h-4 w-4"/> गैलरी से चुनें
                  <input type="file" accept="image/*" className="hidden" multiple onChange={onPick}/>
                </label>
              </div>
            ) : (
              <div className="space-y-3">
                <video ref={videoRef} className="w-full rounded-xl" playsInline muted></video>
                <div className="flex gap-2">
                  <Button onClick={captureFrame} className="bg-orange-600 hover:bg-orange-700"><Camera className="mr-2 h-4 w-4"/> क्लिक करें</Button>
                  <Button variant="secondary" onClick={stopCamera}>रोकें</Button>
                </div>
              </div>
            )}

            <div className="text-xs text-zinc-500">Tip: बेहतर परिणाम के लिए चेहरा साफ़ दिखे ऐसा फोटो लें।</div>
          </CardContent>
        </Card>

        {/* Middle: selected list */}
        <Card className="md:col-span-1">
          <CardContent className="p-4 space-y-3">
            <div className="font-semibold">चुने गए फोटो</div>
            <div className="grid grid-cols-4 gap-2">
              {files.map((f, i) => (
                <button key={i} onClick={() => setActiveIdx(i)} className={`relative group rounded-xl overflow-hidden border ${activeIdx===i?"ring-2 ring-orange-500":""}`}>
                  <img src={URL.createObjectURL(f)} className="w-full h-20 object-cover" />
                  <span className="absolute top-1 right-1 text-[10px] bg-black/60 text-white px-1 rounded">{i+1}</span>
                </button>
              ))}
              {!files.length && <div className="text-xs text-zinc-500">अभी तक कोई फोटो नहीं चुना।</div>}
            </div>
            {files.length>0 && (
              <div className="flex items-center gap-2">
                <Button onClick={() => removeFile(activeIdx)} variant="secondary">हटाएँ</Button>
                <Button onClick={search} className="bg-orange-600 hover:bg-orange-700" disabled={busy}>
                  {busy ? <Loader2 className="mr-2 h-4 w-4 animate-spin"/> : <Search className="mr-2 h-4 w-4"/>}
                  सर्च करें
                </Button>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Right: active preview */}
        <Card className="md:col-span-1">
          <CardContent className="p-4 space-y-3">
            <div className="font-semibold">प्रीव्यू</div>
            {activeFile ? (
              <img src={URL.createObjectURL(activeFile)} alt="preview" className="w-full rounded-xl" />
            ) : (
              <div className="text-sm text-zinc-500">कोई फोटो चुना नहीं है।</div>
            )}
            {LINK_ID ? (
              <div className="text-xs text-zinc-500">Link: <span className="font-mono">{LINK_ID}</span></div>
            ) : (
              <div className="text-xs text-zinc-500">Folder: <span className="font-mono">{DEFAULT_FOLDER}</span> (डिफ़ॉल्ट)</div>
            )}
          </CardContent>
        </Card>
      </section>

      {/* Results */}
      <section className="max-w-6xl mx-auto px-4 mt-6">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold">रिज़ल्ट</div>
          <div className="flex gap-2">
            <Button onClick={downloadSelected} variant="outline"><Download className="mr-2 h-4 w-4"/>चुने हुए डाउनलोड</Button>
          </div>
        </div>
        {results.length === 0 ? (
          <div className="text-sm text-zinc-500">रिज़ल्ट यहाँ दिखेंगे…</div>
        ) : (
          <>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
              {visible.map((r) => (
                <label key={r.id} className="group cursor-pointer">
                  <input type="checkbox" className="hidden" checked={r.checked} onChange={() => toggleCheck(r.id)} />
                  <div className={`rounded-xl overflow-hidden border bg-white shadow-sm group-hover:shadow ${r.checked?"ring-2 ring-orange-500":""}`}>
                    <img src={r.url} className="w-full h-32 object-cover"/>
                    <div className="p-2 text-xs flex items-center justify-between">
                      <span className="font-mono">{Math.round(r.similarity)}%</span>
                      <span className="truncate max-w-[90px]" title={r.key}>{r.key?.split("/").pop()}</span>
                    </div>
                  </div>
                </label>
              ))}
            </div>
            {showCount < results.length && (
              <div className="flex justify-center mt-4">
                <Button onClick={()=>setShowCount((c)=>c+12)} variant="secondary">और दिखाएँ</Button>
              </div>
            )}
          </>
        )}
      </section>

      {/* Footer */}
      <footer className="mt-10 py-6 text-center text-xs text-zinc-500">
        © {new Date().getFullYear()} BJP Mandsaur • Powered by AWS Rekognition • UI by Team
      </footer>
    </div>
  );
}
