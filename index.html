<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Selfie Search</title>
  <style>
    :root { --bg:#0e1420; --panel:#141b2b; --text:#e9eefc; --muted:#b5c0d8; --brand:#ff8a00; --brand-2:#ffb347; --ok:#00d18f; --bad:#ff5d5d; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:1080px;margin-inline:auto;padding:18px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.row{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 0 0 1px rgba(255,255,255,.05) inset}
    .h1{font-size:22px;margin:0 0 12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--brand);color:#000}
    .btn.ghost{background:#1b2236;color:var(--text)}
    .btn.bad{background:var(--bad);color:#000}
    .btn.ok{background:var(--ok);color:#00120b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{background:#1b2236;color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    input[type=text]{width:100%;background:#0f1626;border:1px solid #20283d;border-radius:12px;color:var(--text);padding:12px 14px}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .media{aspect-ratio:4/3;background:#0a101c;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .media img,.media video{width:100%;height:100%;object-fit:cover}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
    .tile{background:#0f1626;border:1px solid #20283d;border-radius:12px;padding:8px}
    .tile img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    .error{border-left:4px solid var(--bad);background:#29171a;padding:10px 12px;border-radius:10px;color:#ffd8d8}
    .okmsg{border-left:4px solid var(--ok);background:#0f2a23;padding:10px 12px;border-radius:10px;color:#caffef}
    .small{font-size:12px}
  </style>

  <!-- ============= CONFIG (यहाँ भरें) ============= -->
  <script>
    window.API = {
      // 1) आपका API Gateway base — सिर्फ़ "/search" तक, बाद में हम "/search" जोड़ते हैं।
      BASE: "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search",

      // 2) आपका current permanent Link ID (Admin से)
      LINK_ID: "3ff7e052ee37",

      // 3) fallback folder (जब LINK_ID ना दें)
      DEFAULT_FOLDER: "common",

      // 4) search defaults
      THRESHOLD: 50,
      MAX_RESULTS: 20
    };
  </script>
</head>
<body>
  <div class="wrap">
    <h1 class="h1">सेल्फ़ी सर्च</h1>

    <div class="row">
      <!-- Left: Camera / File pick -->
      <section class="card">
        <div class="h1">फोटो चुनें या कैमरा से कैप्चर करें</div>

        <div class="media" id="mediaBox">
          <video id="video" playsinline></video>
          <img id="preview" alt="preview" style="display:none" />
        </div>

        <div class="stack" style="margin:12px 0 8px">
          <button class="btn ghost" id="btnStart">कैमरा चालू करें</button>
          <button class="btn ghost" id="btnSnap" disabled>कैप्चर करें</button>
          <button class="btn ghost" id="btnStop" disabled>बंद करें</button>
        </div>

        <input type="file" id="file" accept="image/*" multiple style="margin-top:6px" />
        <div class="muted small" style="margin-top:8px">* अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।</div>
      </section>

      <!-- Right: Selected + Search -->
      <section class="card">
        <div class="stack" style="justify-content:space-between">
          <div class="h1">चुना गया फोटो <span class="muted">(latest)</span></div>
          <span class="pill">folder: link</span>
        </div>

        <div class="media"><img id="selected" alt="selected" /></div>

        <div class="stack" style="margin:12px 0 6px">
          <button class="btn primary" id="btnSearch" disabled>सर्च करें</button>
          <button class="btn ghost" id="btnClear">हटाएँ</button>
          <span class="pill" id="cfgInfo"></span>
        </div>

        <div class="muted small">API:
          <input id="apiField" type="text" readonly />
        </div>
      </section>
    </div>

    <!-- Results -->
    <section class="card" style="margin-top:16px">
      <div class="h1">रिज़ल्ट</div>
      <div id="msg" class="muted">अभी तक सर्च नहीं किया गया।</div>
      <div id="results" class="grid" style="display:none"></div>
    </section>
  </div>

  <script>
    // ---------- read config + URL overrides ----------
    const qs = new URLSearchParams(location.search);

    // BASE pick + trailing slash हटाएँ, और नीचे "/search" हम जोड़ेंगे
    const BASE = (qs.get("base") || (window.API && window.API.BASE) || "").replace(/\/$/, "");
    const LINK_ID = qs.get("link") || (window.API && window.API.LINK_ID) || "";
    const DEFAULT_FOLDER = qs.get("folder") || (window.API && window.API.DEFAULT_FOLDER) || "common";
    const THRESHOLD = Number(qs.get("threshold")) || (window.API && window.API.THRESHOLD) || 50;
    const MAX_RESULTS = Number(qs.get("max")) || (window.API && window.API.MAX_RESULTS) || 20;

    // DOM refs
    const video   = document.getElementById('video');
    const preview = document.getElementById('preview');
    const selected= document.getElementById('selected');
    const file    = document.getElementById('file');
    const btnStart= document.getElementById('btnStart');
    const btnSnap = document.getElementById('btnSnap');
    const btnStop = document.getElementById('btnStop');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear  = document.getElementById('btnClear');
    const apiField  = document.getElementById('apiField');
    const cfgInfo   = document.getElementById('cfgInfo');
    const msg       = document.getElementById('msg');
    const resultsEl = document.getElementById('results');

    apiField.value = BASE || "(missing)";
    cfgInfo.textContent = LINK_ID ? `linkId: ${LINK_ID}` : `folder: ${DEFAULT_FOLDER}`;

    if (!BASE) {
      msg.innerHTML = `<div class="error">API BASE कॉन्फ़िग नहीं है. कृपया window.API.BASE या ?base= सेट करें.</div>`;
    }

    // ---------- helpers ----------
    let stream = null;
    let currentDataUrl = "";

    function setSelected(dataUrl){
      currentDataUrl = dataUrl || "";
      selected.src = dataUrl || "";
      btnSearch.disabled = !dataUrl || !BASE;
    }

    function toDataURLFromFile(f){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(f);
      });
    }

    async function startCam(){
      if (stream) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();
        video.style.display = "";
        preview.style.display = "none";
        btnSnap.disabled = false;
        btnStop.disabled = false;
      }catch(err){
        alert("कैमरा चालू नहीं हो पाया. अनुमति/डिवाइस जाँचें.");
      }
    }

    function stopCam(){
      if (stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      btnSnap.disabled = true;
      btnStop.disabled = true;
    }

    function snap(){
      if (!video.videoWidth) return;
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
      const dataUrl = c.toDataURL('image/jpeg', 0.92);
      preview.src = dataUrl;
      preview.style.display = "";
      video.style.display = "none";
      setSelected(dataUrl);
    }

    // ---------- events ----------
    btnStart.addEventListener('click', startCam);
    btnStop.addEventListener('click', ()=>{ stopCam(); });
    btnSnap.addEventListener('click', snap);

    file.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const dataUrl = await toDataURLFromFile(f); // auto-convert to base64
      setSelected(dataUrl);
    });

    btnClear.addEventListener('click', ()=>{
      setSelected("");
    });

    btnSearch.addEventListener('click', async ()=>{
      if (!currentDataUrl){ alert("पहले फोटो चुनें/कैप्चर करें"); return; }
      if (!BASE){ alert("API BASE कॉन्फ़िग नहीं है."); return; }

      msg.textContent = "खोज रहा है...";
      resultsEl.style.display = "none";
      resultsEl.innerHTML = "";

      // payload बनायें — linkId या allowedFolders में से एक ही भेजना है
      const body = {
        imageBase64: currentDataUrl,
        threshold: THRESHOLD,
        maxResults: MAX_RESULTS
      };
      if (LINK_ID) body.linkId = LINK_ID;
      else body.allowedFolders = [DEFAULT_FOLDER];

      try{
        const r = await fetch(`${BASE}/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const j = await r.json().catch(()=> ({}));

        if (!r.ok){
          msg.innerHTML = `<div class="error">Server Error (${r.status}).</div>`;
          console.warn(j);
          return;
        }

        if (!j || typeof j.count !== "number"){
          msg.innerHTML = `<div class="error">Unexpected response.</div>`;
          console.warn(j);
          return;
        }

        if (j.count <= 0){
          msg.innerHTML = `<div class="okmsg">कोई मिलान नहीं मिला। threshold=${THRESHOLD}</div>`;
          return;
        }

        // render
        msg.innerHTML = `<div class="okmsg">${j.count} मिलान मिले।</div>`;
        resultsEl.style.display = "";
        resultsEl.innerHTML = j.results.map((x,i)=>`
          <div class="tile">
            <img src="${x.downloadUrl || ''}" alt="img"/>
            <div class="small muted" style="margin-top:6px">
              #${i+1} • ${(x.similarity||0).toFixed(1)}% • ${x.folderId || '-'}
            </div>
          </div>
        `).join("");

      }catch(err){
        console.error(err);
        msg.innerHTML = `<div class="error">नेटवर्क/JSON समस्या।</div>`;
      }
    });

    // शुरुवाती state
    setSelected("");
  </script>
</body>
</html>
