<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>भारतीय जनता पार्टी – मंदसौर | Selfie Search</title>

  <!-- Tailwind via CDN (no build step needed) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons (optional) -->
  <link href="https://unpkg.com/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
  <!-- JSZip for bulk download -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bjp:#ff6a00;
      --bjp-dark:#e65f00;
      --ink:#0f172a;
    }
    body{ background:#fff; color:var(--ink);}
    .brand-bar{ background:linear-gradient(90deg,var(--bjp),#ffa733); color:#fff; }
    .btn-bjp{ background:var(--bjp); color:#fff;}
    .btn-bjp:hover{ background:var(--bjp-dark); }
    .card{ box-shadow: 0 8px 22px rgba(0,0,0,.08); }
    .thumb{ aspect-ratio:1/1; object-fit:cover; }
    .grid-auto{ grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="brand-bar">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/4/49/Bharatiya_Janata_Party_logo.svg"
           alt="BJP" class="h-9 w-9 bg-white rounded-full p-1">
      <div class="flex-1">
        <h1 class="text-xl font-bold">भारतीय जनता पार्टी – मंदसौर</h1>
        <p class="text-white/90 text-sm">अपना फोटो खोजें — Selfie Search</p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto w-full px-4 py-6 flex-1">

    <!-- Lead form -->
    <section class="card rounded-2xl p-4 md:p-6 mb-6">
      <h2 class="text-lg md:text-xl font-semibold mb-4">लीड फॉर्म (वैकल्पिक)</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="name" type="text" class="border rounded-xl px-4 py-3"
               placeholder="नाम">
        <input id="mobile" type="tel" inputmode="numeric" class="border rounded-xl px-4 py-3"
               placeholder="मोबाइल">
        <div class="text-sm text-slate-600 flex items-center">*(केवल रजिस्ट्रेशन हेतु)</div>
      </div>
    </section>

    <!-- Capture / select -->
    <section class="card rounded-2xl p-4 md:p-6 mb-6">
      <h2 class="text-lg md:text-xl font-semibold mb-4">फोटो चुने या कैमरा से कैप्चर करें</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Camera -->
        <div class="col-span-1 space-y-3">
          <video id="video" class="w-full rounded-xl border" autoplay playsinline muted></video>
          <div class="flex gap-3">
            <button id="btnStart" class="btn-bjp px-4 py-2 rounded-xl">कैमरा चालू करें</button>
            <button id="btnSnap" class="px-4 py-2 rounded-xl border">कैप्चर करें</button>
            <button id="btnStop" class="px-4 py-2 rounded-xl border">बंद करें</button>
          </div>
          <small class="block text-slate-600">* अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।</small>
        </div>

        <!-- File picker -->
        <div class="col-span-1 space-y-3">
          <input id="picker" type="file" accept="image/*" multiple
                 class="w-full border rounded-xl px-4 py-3" />
          <small class="block text-slate-600">एक या ज़्यादा फोटो चुनें (JPEG/PNG/WebP)</small>
        </div>

        <!-- Preview list -->
        <div class="col-span-1">
          <div class="grid grid-auto gap-3" id="preview"></div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-3">
        <button id="btnSearch" class="btn-bjp px-5 py-3 rounded-xl text-base">सर्च करें</button>
        <span id="busy" class="text-sm text-slate-600 hidden">सर्च हो रहा है…</span>
      </div>
    </section>

    <!-- Results -->
    <section class="card rounded-2xl p-4 md:p-6 mb-28">
      <div class="flex items-center justify-between gap-3 mb-3">
        <h2 class="text-lg md:text-xl font-semibold">रिज़ल्ट</h2>
        <div class="flex items-center gap-3">
          <button id="btnMore" class="px-4 py-2 rounded-xl border">और दिखाएँ</button>
          <button id="btnZip" class="px-4 py-2 rounded-xl border">Bulk ZIP Download</button>
        </div>
      </div>
      <div class="grid grid-auto gap-3" id="results"></div>
      <p id="noResults" class="hidden text-slate-600">कोई मिलान नहीं मिला।</p>
    </section>

  </main>

  <footer class="text-center text-sm text-slate-500 p-4">
    © Selfie Search – BJP Mandsaur
  </footer>


<script>
/* ========== CONFIG ==========
   API Gateway base (आपके पास यही है)  */
const BASE = "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search";
/* URL में ?link=... हो तो वही लिंक-आइडी, नहीं तो common */
const url = new URL(window.location.href);
const LINK_ID = url.searchParams.get("link") || "";
const DEFAULT_FOLDER = "common";
/* ========== STATE ========== */
let files = [];            // File objects or captured blobs
let activeIdx = -1;        // कौन सा प्रीव्यू active है
let stream = null;         // कैमरा स्ट्रीम
let showCount = 12;        // client-side pagination
let resultsList = [];      // last results (array)

/* ========= DOM ========= */
const videoEl   = document.getElementById("video");
const btnStart  = document.getElementById("btnStart");
const btnStop   = document.getElementById("btnStop");
const btnSnap   = document.getElementById("btnSnap");
const picker    = document.getElementById("picker");
const preview   = document.getElementById("preview");
const btnSearch = document.getElementById("btnSearch");
const busy      = document.getElementById("busy");
const resGrid   = document.getElementById("results");
const noRes     = document.getElementById("noResults");
const btnMore   = document.getElementById("btnMore");
const btnZip    = document.getElementById("btnZip");

/* ========= Helpers ========= */
function toast(msg){ alert(msg); }

function addFile(obj){ // File or Blob
  files.push(obj);
  activeIdx = files.length - 1;
  renderPreview();
}

function renderPreview(){
  preview.innerHTML = "";
  files.forEach((f, idx)=>{
    const url = URL.createObjectURL(f);
    const card = document.createElement("div");
    card.className = "border rounded-xl overflow-hidden";
    card.innerHTML = `
      <img src="${url}" class="thumb w-full block ${idx===activeIdx?'ring-4 ring-[--bjp]':''}">
      <div class="p-2 flex items-center justify-between">
        <input type="radio" name="sel" ${idx===activeIdx?'checked':''} />
        <button class="text-xs text-red-600">हटाएँ</button>
      </div>
    `;
    const [radio, del] = card.querySelectorAll("input,button");
    radio.addEventListener("change",()=>{ activeIdx = idx; renderPreview(); });
    del.addEventListener("click",()=>{
      files.splice(idx,1);
      if(activeIdx>=files.length) activeIdx = files.length-1;
      renderPreview();
    });
    preview.appendChild(card);
    URL.revokeObjectURL(url);
  });
}

function blobToDataURL(blob){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(blob);
  });
}

/* ========= Camera actions ========= */
btnStart.addEventListener("click", async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
    videoEl.srcObject = stream;
  }catch(e){
    toast("कैमरा चालू नहीं हो पाया। अनुमति दें/दूसरा ब्राउज़र आज़माएँ।");
  }
});

btnStop.addEventListener("click", ()=>{
  if(!stream) return;
  stream.getTracks().forEach(t=>t.stop());
  stream = null;
  videoEl.srcObject = null;
});

btnSnap.addEventListener("click", async ()=>{
  if(!stream){ toast("पहले कैमरा चालू करें"); return; }
  const v = videoEl;
  const canvas = document.createElement("canvas");
  canvas.width = v.videoWidth; canvas.height = v.videoHeight;
  canvas.getContext("2d").drawImage(v,0,0);
  const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.92));
  addFile(blob);
});

/* ========= File picker ========= */
picker.addEventListener("change", (e)=>{
  const arr = Array.from(e.target.files||[]);
  arr.forEach(f=>addFile(f));
  e.target.value = "";
});

/* ========= Search ========= */
async function doSearch(){
  if(activeIdx<0){ toast("कृपया कोई फोटो चुनें/कैप्चर करें"); return; }
  busy.classList.remove("hidden");
  noRes.classList.add("hidden");
  resGrid.innerHTML = "";
  resultsList = [];
  showCount = 12;

  try{
    const file = files[activeIdx];
    const dataUrl = await blobToDataURL(file); // "data:image/jpeg;base64,..."
    const body = {
      imageBase64: dataUrl,
      threshold: 62,
      maxResults: 100
    };
    if(LINK_ID){
      body.linkId = LINK_ID;
    }else{
      body.allowedFolders = [DEFAULT_FOLDER];
    }

    const r = await fetch(BASE+"/search",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if(!r.ok){ const t = await r.text(); throw new Error(t||("HTTP "+r.status));}
    const json = await r.json();
    resultsList = (json.results||[]);
    renderResults(true);
  }catch(e){
    console.error(e);
    toast("सर्च में समस्या आई। बाद में पुनः प्रयास करें।");
  }finally{
    busy.classList.add("hidden");
  }
}

function renderResults(reset=false){
  if(reset) resGrid.innerHTML="";
  if(resultsList.length===0){ noRes.classList.remove("hidden"); return;}
  noRes.classList.add("hidden");

  const slice = resultsList.slice(0, showCount);
  resGrid.innerHTML = "";
  slice.forEach((x, i)=>{
    const card = document.createElement("div");
    card.className = "border rounded-xl overflow-hidden";
    const s = Math.round(x.similarity||0);
    // try best preview (downloadUrl signed link from API)
    const img = x.downloadUrl || x.previewUrl || "";
    card.innerHTML = `
      <img src="${img}" class="thumb w-full block" referrerpolicy="no-referrer">
      <div class="p-2 space-y-1">
        <div class="text-sm font-medium">${x.key||"image"}</div>
        <div class="text-xs text-slate-600">similarity: <b>${s}%</b></div>
        <label class="text-xs flex items-center gap-2">
          <input type="checkbox" class="dl" />
          डाउनलोड के लिए चुनें
        </label>
        <a href="${img}" download class="text-[--bjp] text-sm">डाउनलोड</a>
      </div>
    `;
    resGrid.appendChild(card);
  });

  // hide/show "more"
  btnMore.classList.toggle("hidden", showCount>=resultsList.length);
}

btnSearch.addEventListener("click", doSearch);
btnMore.addEventListener("click", ()=>{
  showCount += 12;
  renderResults();
});

/* ========= Bulk ZIP ========= */
btnZip.addEventListener("click", async ()=>{
  const checks = resGrid.querySelectorAll(".dl");
  const pick = [];
  let idx=0;
  for(const c of checks){
    if(c.checked){
      // same index order
      const item = resultsList[idx];
      if(item && item.downloadUrl) pick.push(item.downloadUrl);
    }
    idx++;
  }
  if(pick.length===0){ toast("कृपया कुछ फोटो चुनें"); return; }

  try{
    const zip = new JSZip();
    let k=1;
    for(const url of pick){
      const r = await fetch(url,{cache:"no-store"});
      const blob = await r.blob();
      const ext = (blob.type.split("/")[1]||"jpg").replace("+xml","");
      const name = `photo_${String(k).padStart(3,"0")}.${ext}`;
      zip.file(name, blob);
      k++;
    }
    const z = await zip.generateAsync({type:"blob"});
    saveAs(z, `selected_${new Date().toISOString().slice(0,10)}.zip`);
  }catch(e){
    console.error(e); toast("ZIP बनाते समय समस्या आई।");
  }
});
</script>

</body>
</html>
