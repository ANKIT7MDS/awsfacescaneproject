<!doctype html>
<html lang="hi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>भारतीय जनता पार्टी – मंदसौर | Selfie Search</title>

    <!-- Tailwind (CDN) — Netlify पर ठीक है; चाहें तो PostCSS build में शिफ्ट कर लें -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- JSZip for bulk download -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    </style>
  </head>
  <body class="bg-white text-slate-900">
    <!-- Header -->
    <header class="border-b bg-white sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6e/Bharatiya_Janata_Party_logo.svg"
               alt="BJP" class="h-6 w-6" />
          <h1 class="text-lg md:text-xl font-semibold">भारतीय जनता पार्टी – मंदसौर</h1>
        </div>
        <div class="text-sm text-slate-600">Selfie Search</div>
      </div>
    </header>

    <!-- App root -->
    <main id="root" class="max-w-7xl mx-auto px-4 py-6"></main>

    <script type="text/javascript">
      const { useState, useRef } = React;

      // ====== CONFIG ======
    const BASE =
  new URLSearchParams(location.search).get("base") ||
  (window.BASE || "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search");
      const DEFAULT_FOLDER = "common";

      function App() {
        // lead form (वैकल्पिक)
        const [name, setName] = useState("");
        const [mobile, setMobile] = useState("");

        // single image state
        const [file, setFile] = useState(null);
        const [busy, setBusy] = useState(false);

        // results
        const [results, setResults] = useState([]);
        const [showCount, setShowCount] = useState(24);

        // camera refs
        const videoRef = useRef(null);
        const streamRef = useRef(null);

        // linkId (अगर sharable link से आये)
        const params = new URLSearchParams(location.search);
        const LINK_ID = params.get("link") || "";

        // ----- Camera -----
        const startCamera = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            streamRef.current = stream;
            if (videoRef.current) videoRef.current.srcObject = stream;
          } catch (err) {
            console.error(err);
            alert("कैमरा चालू नहीं हो पाया। कृपया ब्राउज़र/डिवाइस अनुमति दें।");
          }
        };
        const stopCamera = () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(t => t.stop());
            streamRef.current = null;
          }
        };
        const captureFrame = () => {
          if (!videoRef.current) return;
          const video = videoRef.current;
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth || 720;
          canvas.height = video.videoHeight || 720;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            if (!blob) return alert("कैप्चर नहीं हो पाया।");
            const f = new File([blob], `selfie_${Date.now()}.jpg`, { type: "image/jpeg" });
            setFile(f); // single active file
          }, "image/jpeg", 0.92);
        };

        // Files से latest को active रखें
        const onFileChange = (ev) => {
          const f = ev.target.files && ev.target.files[0];
          if (!f) return;
          setFile(f);
        };

        // helper : file -> dataURL
        const fileToDataUrl = (f) =>
          new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result);
            r.onerror = reject;
            r.readAsDataURL(f);
          });

        // ----- SEARCH -----
        const search = async () => {
          if (!file) return alert("कृपया पहले एक फोटो चुनें/कैप्चर करें।");
          try {
            setBusy(true);
            setResults([]);
            setShowCount(24);

            const dataUrl = await fileToDataUrl(file);

            // यदि sharable `link` query param है तो वही rules लागू; वरना default folder
            const body = {
              imageBase64: dataUrl,
              linkId: LINK_ID || undefined,
              allowedFolders: LINK_ID ? undefined : [DEFAULT_FOLDER],
              threshold: 65,
              maxResults: 200
            };

            const res = await fetch(`${BASE}/search`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error(`Search failed: ${res.status}`);
            const json = await res.json();
            setResults(json?.results || []);
          } catch (e) {
            console.error(e);
            alert("सर्च करते समय समस्या हुई।");
          } finally {
            setBusy(false);
          }
        };

        // Bulk ZIP download
        const bulkZip = async () => {
          if (!results.length) return alert("डाउनलोड करने के लिए रिज़ल्ट नहीं हैं।");
          const zip = new JSZip();

          // बहुत ज़्यादा बड़ी ZIP न बनायें; जरुरत हो तो सीमित रखें
          const toZip = results.slice(0, 200);

          for (let i = 0; i < toZip.length; i++) {
            const r = toZip[i];
            try {
              const resp = await fetch(r.downloadUrl);
              const blob = await resp.blob();
              const name = `${String(i + 1).padStart(3, "0")}_${(r.similarity || 0).toFixed(0)}.jpg`;
              zip.file(name, blob);
            } catch (e) {
              console.warn("skip:", r.downloadUrl, e);
            }
          }
          const out = await zip.generateAsync({ type: "blob" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(out);
          a.download = `results_${Date.now()}.zip`;
          a.click();
          URL.revokeObjectURL(a.href);
        };

        return (
          React.createElement("div", { className: "space-y-6" },

            // Lead form (optional)
            React.createElement("section", { className: "grid grid-cols-1 md:grid-cols-3 gap-3 items-center" }, [
              React.createElement("input", {
                key: "name",
                type: "text",
                value: name,
                onChange: (e) => setName(e.target.value),
                placeholder: "आपका नाम",
                className: "border rounded px-3 py-2 w-full"
              }),
              React.createElement("input", {
                key: "mobile",
                type: "tel",
                value: mobile,
                onChange: (e) => setMobile(e.target.value),
                placeholder: "मोबाइल",
                className: "border rounded px-3 py-2 w-full"
              }),
              React.createElement("div", { key: "note", className: "text-sm text-slate-500" }, " * केवल रजिस्ट्रेशन हेतु ")
            ]),

            // Camera + File + Single Preview
            React.createElement("section", { className: "grid grid-cols-1 md:grid-cols-2 gap-8" }, [
              // Left: Camera + inputs
              React.createElement("div", { key: "left" }, [
                React.createElement("h2", { className: "text-xl font-semibold mb-4" }, "फोटो चुनें या कैमरा से कैप्चर करें"),

                React.createElement("div", { className: "rounded-lg overflow-hidden bg-black aspect-video mb-3" },
                  React.createElement("video", {
                    ref: videoRef, autoPlay: true, playsInline: true, muted: true,
                    className: "w-full h-full object-cover"
                  })
                ),

                React.createElement("div", { className: "flex items-center gap-3 mb-6" }, [
                  React.createElement("button", {
                    key: "c1",
                    onClick: startCamera,
                    className: "px-3 py-1.5 rounded bg-orange-600 text-white"
                  }, "कैमरा चालू करें"),
                  React.createElement("button", {
                    key: "c2",
                    onClick: captureFrame,
                    className: "px-3 py-1.5 rounded bg-slate-700 text-white"
                  }, "कैप्चर करें"),
                  React.createElement("button", {
                    key: "c3",
                    onClick: stopCamera,
                    className: "px-3 py-1.5 rounded bg-slate-500 text-white"
                  }, "बंद करें")
                ]),

                React.createElement("div", { className: "mb-2" }, "एक फोटो चुनें (JPEG/PNG/WebP)"),
                React.createElement("input", {
                  type: "file", accept: "image/*", onChange: onFileChange, className: "block"
                }),
                React.createElement("div", { className: "text-slate-500 text-sm mt-2" },
                  " * अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।")
              ]),

              // Right: Single Preview + actions
              React.createElement("div", { key: "right" }, [
                React.createElement("h2", { className: "text-xl font-semibold mb-4" }, "चुना गया फोटो (latest)"),
                React.createElement("div", { className: "min-h-[120px]" },
                  file
                    ? React.createElement("img", {
                        src: URL.createObjectURL(file),
                        alt: "selected",
                        className: "rounded shadow max-w-[240px] border"
                      })
                    : React.createElement("div", { className: "text-slate-500" }, "अभी कोई फोटो चयनित नहीं है")
                ),
                React.createElement("div", { className: "flex items-center gap-3 mt-4" }, [
                  React.createElement("button", {
                    key: "s1",
                    disabled: !file || busy,
                    onClick: search,
                    className: "px-3 py-1.5 rounded bg-orange-600 text-white disabled:opacity-60"
                  }, busy ? "सर्च हो रहा है…" : "सर्च करें"),
                  file && React.createElement("button", {
                    key: "s2",
                    onClick: () => setFile(null),
                    className: "px-3 py-1.5 rounded bg-slate-500 text-white"
                  }, "हटाएँ")
                ]),
                React.createElement("div", { className: "text-sm text-slate-500 mt-6" },
                  "Folder: ", React.createElement("span", { className: "px-2 py-0.5 rounded bg-slate-100" }, DEFAULT_FOLDER))
              ])
            ]),

            // Results
            React.createElement("section", null, [
              React.createElement("h3", { key: "r1", className: "text-xl font-semibold mb-3" }, "रिज़ल्ट"),
              results.length === 0
                ? React.createElement("div", { key: "r2", className: "text-slate-500" }, "कोई मिलान नहीं मिला।")
                : React.createElement("div", { key: "r3", className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4" },
                    results.slice(0, showCount).map((r, idx) =>
                      React.createElement("a", {
                        key: idx,
                        href: r.downloadUrl,
                        target: "_blank",
                        rel: "noreferrer",
                        className: "block border rounded overflow-hidden hover:shadow-md"
                      }, [
                        React.createElement("img", {
                          key: "img",
                          src: r.downloadUrl,
                          alt: `match-${idx}`,
                          className: "w-full aspect-square object-cover"
                        }),
                        React.createElement("div", { key: "cap", className: "px-2 py-1 text-sm flex items-center justify-between" }, [
                          React.createElement("span", { key: "s" }, `${Math.round(r.similarity || 0)}%`),
                          React.createElement("span", { key: "f", className: "text-slate-500" }, r.folderId || "")
                        ])
                      ])
                    )
                  ),
              results.length > showCount &&
                React.createElement("div", { key: "more", className: "mt-4" },
                  React.createElement("button", {
                    onClick: () => setShowCount(c => c + 24),
                    className: "px-3 py-1.5 rounded border"
                  }, "और दिखाएँ")
                ),
              results.length > 0 &&
                React.createElement("div", { key: "zip", className: "mt-4" },
                  React.createElement("button", {
                    onClick: bulkZip,
                    className: "px-3 py-1.5 rounded border"
                  }, "Bulk ZIP Download")
                )
            ])
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
</html>
