<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>भारतीय जनता पार्टी मंदसौर – फोटो सर्च</title>
  <style>
    :root{
      --saffron:#ff6a00; --saffron-dark:#e05d00; --card:#fff9f2; --text:#1b1b1b;
      --muted:#f1f1f1; --border:#e6e6e6;
    }
    body{margin:0;background:var(--card);color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans;}
    .container{max-width:1000px;margin:0 auto;padding:12px;}
    .header{position:sticky;top:0;z-index:20;background:var(--saffron);color:#fff;}
    .header-inner{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:12px;}
    .title{font-weight:700;font-size:22px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:768px){ .row3{grid-template-columns:1fr 1fr 1fr} }
    input[type="text"],input[type="tel"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;outline:none}
    button{appearance:none;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn{background:var(--saffron-dark);color:#fff}
    .btn.outline{background:#fff;color:var(--text);border:1px solid var(--border)}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    @media(min-width:768px){ .grid{grid-template-columns:repeat(4, minmax(0,1fr))} }
    .thumb{position:relative}
    .thumb img{width:100%;height:180px;object-fit:cover;display:block}
    .thumb input[type="checkbox"]{position:absolute;top:8px;left:8px;width:20px;height:20px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:10px 0}
    .muted{font-size:13px;color:#555}
    .preview{max-height:260px;border:1px solid var(--border);border-radius:8px}
    .error{color:#b00020;font-size:14px;margin-top:8px}
    .footer-space{height:80px}
  </style>
  <script>
    // CONFIG
    const API_BASE = "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search"; // <- आपका base
    // Public search में Authorization नहीं भेजना
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-inner container">
      <div class="title">भारतीय जनता पार्टी मंदसौर</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="linkId" type="text" placeholder="पब्लिक linkId" style="width:230px;padding:9px;border-radius:8px;border:1px solid #fff">
        <button class="btn" id="btnSearch">सर्च</button>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="container">
    <div class="row row3">
      <div>
        <label class="muted">नाम (हिंदी)</label>
        <input type="text" id="nameHi" placeholder="जैसे: राम शर्मा">
      </div>
      <div>
        <label class="muted">मोबाइल</label>
        <input type="tel" id="mobile" placeholder="10 अंकों का" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
      </div>
      <div>
        <label class="muted">फ़ोटो चुनें</label>
        <input type="file" id="file" accept="image/*">
      </div>
    </div>

    <div id="previewWrap" style="margin-top:12px;display:none">
      <div class="muted">प्रीव्यू</div>
      <img id="preview" class="preview" alt="preview">
    </div>

    <div id="error" class="error" style="display:none"></div>
  </div>

  <!-- Results -->
  <div class="container">
    <div id="tools" class="toolbar" style="display:none">
      <div class="muted" id="counts">कुल परिणाम: 0</div>
      <div style="display:flex;gap:8px">
        <button class="btn outline" id="btnSelectPage">इस पेज के सभी चुनें</button>
        <button class="btn outline" id="btnClearSel">सभी हटाएँ</button>
        <button class="btn" id="btnZip">बल्क डाउनलोड</button>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="pager" style="display:none;gap:8px;justify-content:center;margin:14px 0;display:flex">
      <button class="btn outline" id="prev">पिछला</button>
      <button class="btn outline" id="next">अगला</button>
    </div>
  </div>

  <div class="footer-space"></div>

<script>
  const el = (id)=>document.getElementById(id);
  const state = { results:[], selected:{}, page:0, pageSize:20, preview:"", file:null, busy:false };

  // preview
  el('file').addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    state.file = f || null;
    if(!f){ el('previewWrap').style.display='none'; return; }
    const r = new FileReader();
    r.onload = ()=>{ state.preview = r.result; el('preview').src = state.preview; el('previewWrap').style.display='block'; };
    r.readAsDataURL(f);
  });

  el('btnSearch').addEventListener('click', doSearch);

  async function doSearch(){
    try{
      if(state.busy) return;
      if(!state.file) return showErr('कृपया फ़ोटो चुनें');
      const linkId = el('linkId').value.trim();
      if(!linkId) return showErr('linkId आवश्यक है');

      showErr('');
      state.busy = true;
      state.results=[]; state.selected={}; state.page=0;
      draw();

      const body = {
        imageBase64: state.preview,
        linkId,
        threshold: 65,
        maxResults: 200,
        meta: { nameHi: el('nameHi').value.trim(), mobile: el('mobile').value.trim() }
      };
      const res = await fetch(API_BASE + '/search', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error('Search failed: ' + t);
      }
      const json = await res.json();
      state.results = json.results || [];
      state.page = 0;
      draw();
    }catch(err){
      showErr(err.message||'त्रुटि');
    }finally{
      state.busy=false;
    }
  }

  function showErr(msg){
    if(!msg){ el('error').style.display='none'; el('error').textContent=''; return; }
    el('error').style.display='block';
    el('error').textContent = msg;
  }

  function pageItems(){
    const s = state.page*state.pageSize;
    return state.results.slice(s, s+state.pageSize);
  }

  function draw(){
    const items = pageItems();
    el('counts').textContent = 'कुल परिणाम: ' + state.results.length + ' | पेज: ' + (state.page+1) + ' / ' + Math.max(1, Math.ceil(state.results.length/state.pageSize));
    el('tools').style.display = state.results.length? 'flex':'none';
    el('pager').style.display = (state.results.length>state.pageSize)? 'flex':'none';

    // grid
    const g = el('grid');
    g.innerHTML = '';
    items.forEach(r=>{
      const d = document.createElement('div');
      d.className='card';
      d.innerHTML = `
        <div class="thumb">
          <img src="${r.downloadUrl}" alt="${r.key}">
          <input type="checkbox" ${state.selected[r.key]?'checked':''}>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;font-size:12px">
          <span>मैच: ${Math.round(r.similarity||0)}%</span>
          <a href="${r.downloadUrl}" target="_blank">खोलें</a>
        </div>`;
      const cb = d.querySelector('input[type="checkbox"]');
      cb.addEventListener('change', ()=>{ state.selected[r.key] = cb.checked; });
      g.appendChild(d);
    });
  }

  el('prev').addEventListener('click', ()=>{ state.page=Math.max(0,state.page-1); draw(); });
  el('next').addEventListener('click', ()=>{ const last=Math.ceil(state.results.length/state.pageSize)-1; state.page=Math.min(last,state.page+1); draw(); });
  el('btnClearSel').addEventListener('click', ()=>{ state.selected={}; draw(); });
  el('btnSelectPage').addEventListener('click', ()=>{ pageItems().forEach(r=>{ state.selected[r.key]=true; }); draw(); });

  el('btnZip').addEventListener('click', async ()=>{
    const picks = state.results.filter(r => state.selected[r.key]);
    if(!picks.length) return alert('पहले कुछ फ़ोटो चयन करें');
    const zip = new JSZip();
    for(let i=0;i<picks.length;i++){
      const r = picks[i];
      const rsp = await fetch(r.downloadUrl);
      if(!rsp.ok) continue;
      const blob = await rsp.blob();
      const name = (r.key && r.key.split('/').pop()) || ('image-'+(i+1)+'.jpg');
      zip.file(name, blob);
    }
    const out = await zip.generateAsync({type:'blob'});
    saveAs(out,'results.zip');
  });
</script>
</body>
</html>
