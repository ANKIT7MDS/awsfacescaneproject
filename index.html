<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selfie Search ‚Äî Inline Camera (FotoOwl-like)</title>
  <style>
    :root{
      --bg:#fff8f1;--panel:#ffffff;--text:#111827;--muted:#6b7280;--line:#f1e6d8;
      --brand:#ff2c2c;--brand2:#ff6a6a;--ok:#10b981;--bad:#ef4444;
      --chip:#fff1e0;--shadow:0 8px 24px rgba(255,0,0,.18)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1120px;margin-inline:auto;padding:18px}
    header{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .title{font-size:24px;font-weight:800}
    .subtitle{font-size:15px;color:#374151}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 14px rgba(0,0,0,.04)}

    .h1{font-size:18px;margin:0 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#8b5a2b}

    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .05s ease, box-shadow .2s}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;box-shadow:var(--shadow)}
    .btn.ghost{background:#fff;color:#3b3b3b;border:1px solid var(--line)}
    .btn.ok{background:#dcfce7;color:#14532d;border:1px solid #bbf7d0}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Inline camera box */
    .media{aspect-ratio:1/1;background:#000;border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .media video,.media img{width:100%;height:100%;object-fit:cover}
    .ring{position:absolute;inset:10px;border-radius:999px;border:2px dashed rgba(255,255,255,.28);pointer-events:none}
    .mesh{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .mesh svg{width:64%;opacity:.9}

    /* Results grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:10px}
    .tile{background:#fff;border:1px solid var(--line);border-radius:12px;position:relative;overflow:hidden}
    .tile img{display:block;width:100%;height:230px;object-fit:cover;cursor:pointer}
    .tile.selected{outline:3px solid var(--ok);outline-offset:-3px}
    .check-badge{position:absolute;top:8px;left:8px;background:var(--ok);color:#062e24;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:800;display:none}
    .tile.selected .check-badge{display:inline-block}
    .dl{position:absolute;right:8px;bottom:8px;border:0;border-radius:10px;padding:6px 8px;background:#ffffffcc;backdrop-filter:blur(6px);cursor:pointer}

    .sticky-bar{position:sticky;bottom:0;z-index:5;background:#fffbeccc;backdrop-filter:blur(6px);padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:12px;display:flex;justify-content:space-between;align-items:center}

    .note{font-size:12px;color:var(--muted)}
    .error{border-left:4px solid var(--bad);background:#fff1f2;padding:10px 12px;border-radius:10px;color:#7f1d1d}
    .okmsg{border-left:4px solid var(--ok);background:#ecfdf5;padding:10px 12px;border-radius:10px;color:#064e3b}

    /* Toast */
    .toast{position:fixed;top:14px;right:14px;background:#111827;color:#fff;border:1px solid #374151;border-radius:10px;padding:10px 14px;z-index:60;display:none;box-shadow:0 10px 20px rgba(0,0,0,.35)}
    .toast.show{display:block}

    /* Lightbox / Slide view */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:50;padding:18px}
    .lightbox.show{display:flex}
    .lightbox img{max-width:92vw;max-height:86vh;border-radius:12px}
    .lb-close{position:fixed;top:12px;right:14px;font-size:22px;background:rgba(0,0,0,.5);color:#fff;border:0;border-radius:999px;width:36px;height:36px;display:grid;place-items:center;cursor:pointer}
    .lb-nav{position:fixed;top:50%;transform:translateY(-50%);font-size:40px;background:rgba(0,0,0,.45);color:#fff;border:0;border-radius:10px;padding:6px 10px;cursor:pointer}
    .lb-prev{left:14px}.lb-next{right:14px}

    /* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ file input ‡§õ‡§ø‡§™‡§æ‡§è‡§Å */
    @media (max-width:640px){ #fileRow{display:none} }
  </style>

  <!-- CONFIG (defaults preserved) -->
  <script>
    window.API = {
      BASE: "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search",
      LINK_ID: "3ff7e052ee37",
      DEFAULT_FOLDER: "common",
      THRESHOLD: 95,
      MAX_RESULTS: 200
    };
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞</div>
      <div class="subtitle">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ú‡§®‡§§‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§ï‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•á ‡§´‡•ã‡§ü‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</div>
    </header>

    <section class="card" id="cameraCard">
      <div class="h1">‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§Ø‡§π‡•Ä‡§Ç ‡§∏‡•á ‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç</div>
      <div class="media" id="mediaBox">
        <video id="video" playsinline></video>
        <img id="preview" alt="preview" style="display:none" />
        <div class="ring"></div>
        <div class="mesh" aria-hidden="true">
          <svg viewBox="0 0 100 100">
            <g fill="none" stroke="rgba(255,200,0,.9)" stroke-width=".6">
              <polygon points="20,30 50,15 80,30 85,55 50,90 15,55"/>
              <polyline points="20,30 50,50 80,30"/>
              <polyline points="15,55 50,70 85,55"/>
              <polyline points="50,15 50,70 50,90"/>
            </g>
          </svg>
        </div>
      </div>

      <div class="stack" style="margin:12px 0 6px">
        <button class="btn ghost" id="btnStart">Open Camera</button>
        <button class="btn ghost" id="btnSnap" disabled>Capture</button>
        <button class="btn primary" id="btnSearch" disabled>Search</button>
        <span class="pill" id="cfgInfo"></span>
      </div>

      <div id="fileRow" class="stack" style="margin-top:6px">
        <input type="file" id="file" accept="image/*" multiple />
        <span class="note">* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§Ø‡§π ‡§õ‡§ø‡§™‡§æ ‡§∞‡§π‡•á‡§ó‡§æ ‚Äì ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•á ‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§≤‡•á‡§Ç</span>
      </div>

      <div class="note" style="margin-top:8px">API: <input id="apiField" type="text" readonly style="width:100%" /> <span class="pill" id="folderInfo" style="margin-left:8px"></span></div>
    </section>

    <!-- Toast -->
    <div id="toast" class="toast">üîé ‡§Ü‡§™‡§ï‡•Ä ‡§´‡§º‡•ã‡§ü‡•ã ‡§ñ‡•ã‡§ú‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç‚Ä¶</div>

    <!-- Results -->
    <section class="card" id="resultsCard" style="margin-top:16px">
      <div class="h1">Results</div>
      <div class="stack" style="align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="stack">
          <label class="pill">Page size
            <select id="pageSize" style="width:auto;margin-left:8px">
              <option>12</option><option selected>24</option><option>48</option><option>96</option>
            </select>
          </label>
          <span id="countBadge" class="pill">0</span>
        </div>
        <div class="stack">
          <button class="btn ghost" id="btnPrev" disabled>‚óÄÔ∏é Prev</button>
          <span class="pill" id="pageBadge">1 / 1</span>
          <button class="btn ghost" id="btnNext" disabled>Next ‚ñ∂Ô∏é</button>
        </div>
      </div>

      <div id="msg" class="note">No search yet.</div>
      <div id="results" class="grid" style="display:none"></div>

      <div class="sticky-bar">
        <button class="btn ghost" id="btnToggleAll">Select all</button>
        <button class="btn ok" id="btnDownloadSel" disabled>Download selected</button>
      </div>
    </section>

    <!-- Lightbox / Slide View -->
    <div id="lightbox" class="lightbox" aria-hidden="true">
      <button class="lb-close" id="lbClose" title="Close">√ó</button>
      <button class="lb-nav lb-prev" id="lbPrev" title="Previous">‚Äπ</button>
      <img id="lightImg" alt="zoom" />
      <button class="lb-nav lb-next" id="lbNext" title="Next">‚Ä∫</button>
    </div>
  </div>

  <script>
    /* ---------- Config ---------- */
    const qs = new URLSearchParams(location.search);
    let BASE = (qs.get("base") || (window.API && window.API.BASE) || "").replace(/\/$/, "");
    let LINK_ID = qs.get("link") || (window.API && window.API.LINK_ID) || "";
    let DEFAULT_FOLDER = qs.get("folder") || (window.API && window.API.DEFAULT_FOLDER) || "common";
    let THRESHOLD = Number(qs.get("threshold")) || (window.API && window.API.THRESHOLD) || 50;
    let MAX_RESULTS = Number(qs.get("max")) || (window.API && window.API.MAX_RESULTS) || 200;

    // Hard fallbacks
    if(!BASE) BASE = "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search";
    if(!LINK_ID) LINK_ID = "3ff7e052ee37";

    const SEARCH_URL = /\/search$/.test(BASE) ? BASE : `${BASE}/search`;

    /* ---------- DOM ---------- */
    const video   = document.getElementById('video');
    const preview = document.getElementById('preview');
    const file    = document.getElementById('file');
    const btnStart= document.getElementById('btnStart');
    const btnSnap = document.getElementById('btnSnap');
    const btnSearch = document.getElementById('btnSearch');
    const apiField  = document.getElementById('apiField');
    const cfgInfo   = document.getElementById('cfgInfo');
    const folderInfo= document.getElementById('folderInfo');
    const msg       = document.getElementById('msg');
    const resultsEl = document.getElementById('results');
    const pageSizeSel = document.getElementById('pageSize');
    const pageBadge = document.getElementById('pageBadge');
    const countBadge = document.getElementById('countBadge');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnToggleAll = document.getElementById('btnToggleAll');
    const btnDownloadSel = document.getElementById('btnDownloadSel');

    const toast = document.getElementById('toast');

    apiField.value = SEARCH_URL || "(missing)";
    cfgInfo.textContent = LINK_ID ? `linkId: ${LINK_ID}, max=${MAX_RESULTS}` : `folder: ${DEFAULT_FOLDER}, max=${MAX_RESULTS}`;
    folderInfo.textContent = LINK_ID ? "folder: link" : `folder: ${DEFAULT_FOLDER}`;

    /* ---------- Camera (inline) ---------- */
    let stream = null, currentDataUrl = "";  // ‡§Ø‡§π‡•Ä dataUrl search ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§è‡§ó‡§æ

    function setSelected(dataUrl){
      currentDataUrl = dataUrl || "";
      btnSearch.disabled = !dataUrl || !SEARCH_URL;
    }

    function toDataURLFromFile(f){
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
    }

    async function startCam(){
      if (stream) return;
      try{
        if(location.protocol!=='https:' && location.hostname!=='localhost'){
          console.warn('Camera requires HTTPS.');
        }
        stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:false });
        video.setAttribute('playsinline','');
        video.setAttribute('autoplay','');
        video.muted = true;
        video.srcObject = stream;
        video.onloadedmetadata = async()=>{ try{ await video.play(); }catch(e){ console.warn('autoplay blocked', e);} };
        video.style.display=""; preview.style.display="none";
        btnSnap.disabled=false;
      }catch(err){ alert("Camera not available. Please allow permission and HTTPS."); console.error(err); }
    }

    function snap(){
      if (!video.videoWidth) return;
      const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      const dataUrl=c.toDataURL('image/jpeg',.92);
      preview.src=dataUrl; preview.style.display=""; video.style.display="none";
      setSelected(dataUrl);
      // Capture -> Retake
      btnSnap.textContent = 'Retake'; btnSnap.dataset.mode='retake';
    }

    btnStart.onclick=startCam;
    btnSnap.onclick=()=>{
      if(btnSnap.dataset.mode==='retake'){
        preview.style.display='none'; video.style.display=''; btnSnap.textContent='Capture'; btnSnap.dataset.mode='capture'; return;
      }
      snap();
    };

    if (file){ file.onchange = async (ev)=>{ const f=ev.target.files?.[0]; if(!f) return; setSelected(await toDataURLFromFile(f)); }; }

    /* ---------- Search + Pagination ---------- */
    let allResults = [];
    let currentPage = 1;
    function pageSize(){ return Number(pageSizeSel.value)||24; }

    function updatePager(){
      const total = allResults.length;
      const ps = pageSize();
      const totalPages = Math.max(1, Math.ceil(total / ps));
      if (currentPage > totalPages) currentPage = totalPages;
      pageBadge.textContent = `${currentPage} / ${totalPages}`;
      countBadge.textContent = `${total} results`;
      btnPrev.disabled = (currentPage<=1);
      btnNext.disabled = (currentPage>=totalPages);
      const anySel = resultsEl.querySelectorAll('.tile.selected').length>0;
      btnDownloadSel.disabled = !anySel;
      // Toggle-all label
      const tiles = resultsEl.querySelectorAll('.tile');
      const allSelected = tiles.length>0 && [...tiles].every(t=>t.classList.contains('selected'));
      btnToggleAll.textContent = allSelected ? 'Unselect all' : 'Select all';
    }

    function renderPage(){
      const ps = pageSize();
      const start = (currentPage-1)*ps;
      const slice = allResults.slice(start, start+ps);

      resultsEl.innerHTML = slice.map((x,i)=>`
        <div class="tile" data-idx="${start+i}">
          <span class="check-badge">‚úì</span>
          <img src="${x.downloadUrl||''}" alt="match"/>
          <button class="dl" title="Download" data-url="${x.downloadUrl||''}">‚¨áÔ∏é</button>
        </div>
      `).join("");
      resultsEl.style.display = slice.length ? "" : "none";
      updatePager();
    }

    // Event delegation for grid
    resultsEl.addEventListener('click', async (e)=>{
      const tile = e.target.closest('.tile');
      if(!tile) return;
      if(e.target.closest('.dl')){ // per-photo download
        const url = e.target.getAttribute('data-url');
        if(url) try{ await forceDownload(url); }catch(err){ console.warn('download failed', url, err); }
        return;
      }
      if(e.target.tagName==='IMG'){ // open lightbox
        openLightbox(Number(tile.dataset.idx)); return;
      }
      // toggle select on tile body
      tile.classList.toggle('selected'); updatePager();
    });

    btnPrev.onclick = ()=>{ currentPage--; renderPage(); };
    btnNext.onclick = ()=>{ currentPage++; renderPage(); };
    pageSizeSel.onchange = ()=>{ currentPage=1; renderPage(); };

    btnToggleAll.onclick = ()=>{
      const tiles = [...resultsEl.querySelectorAll('.tile')];
      const allSelected = tiles.length && tiles.every(t=> t.classList.contains('selected'));
      tiles.forEach(t=> t.classList.toggle('selected', !allSelected));
      updatePager();
    };

    function fileNameFromUrl(u){ try{ return decodeURIComponent(new URL(u).pathname.split('/').pop()||'photo.jpg'); }catch{return 'photo.jpg'} }
    async function forceDownload(url){ const resp = await fetch(url,{mode:'cors'}); const blob = await resp.blob(); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileNameFromUrl(url); document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 50); }

    document.getElementById('btnSearch').onclick = async ()=>{
      // Scroll to results and show toast
      document.getElementById('resultsCard').scrollIntoView({behavior:'smooth'});
      toast.classList.add('show');

      if (!currentDataUrl){ alert("Pick/Capture a photo first."); toast.classList.remove('show'); return; }
      if (!SEARCH_URL){ alert("API BASE is missing."); toast.classList.remove('show'); return; }

      msg.textContent = "Searching..."; resultsEl.style.display="none"; resultsEl.innerHTML="";

      const body = { imageBase64: currentDataUrl, threshold: THRESHOLD, maxResults: MAX_RESULTS };
      if (LINK_ID) body.linkId = LINK_ID; else body.allowedFolders = [DEFAULT_FOLDER];

      try{
        const r = await fetch(SEARCH_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        const text = await r.text();
        let j = {};
        try{ j = text ? JSON.parse(text) : {}; }catch(parseErr){ j = { __raw:text }; }

        if (!r.ok){ msg.innerHTML = `<div class="error">Server Error (${r.status}).</div>`; console.warn(j); toast.classList.remove('show'); return; }

        // Normalize various possible shapes => array of {downloadUrl}
        function pickUrl(o){ return o.downloadUrl||o.url||o.signedUrl||o.imageUrl||o.src||o.link||""; }
        function toArray(x){ if(Array.isArray(x)) return x; if(!x) return []; return Object.values(x); }
        let arr = [];
        if(Array.isArray(j.results)) arr = j.results;
        else if(Array.isArray(j.photos)) arr = j.photos;
        else if(Array.isArray(j.items)) arr = j.items;
        else if(j.data && Array.isArray(j.data.results)) arr = j.data.results;
        else if(j.body && Array.isArray(j.body.results)) arr = j.body.results;
        else if(j.matches && Array.isArray(j.matches)) arr = j.matches;
        else if(j.images && Array.isArray(j.images)) arr = j.images;
        else if(typeof j === 'object' && Object.keys(j).length && Array.isArray(j[Object.keys(j)[0]])) arr = j[Object.keys(j)[0]]; // fallback first array field

        if(!arr || !arr.length){
          const keys = j && typeof j==='object' ? Object.keys(j).join(', ') : typeof j;
          msg.innerHTML = `<div class="error">Unexpected response. Keys: ${keys || 'none'}</div>`;
          console.warn('Unexpected response shape', j);
          toast.classList.remove('show');
          return;
        }

        // map to unified structure
        arr = arr.map(it=> ({ downloadUrl: pickUrl(it), ...it })).filter(x=> !!x.downloadUrl);

        // De-duplicate by canonical URL (origin+pathname)
        const canon = (u)=>{ try{ const x=new URL(u); return x.origin + x.pathname.toLowerCase(); }catch{return (u||'').toLowerCase(); } };
        const seen = new Set();
        allResults = arr.filter(it=>{ const k = canon(it.downloadUrl||''); if(seen.has(k)) return false; seen.add(k); return true; });

        if (j.count && j.count > allResults.length){
          msg.innerHTML = `<div class="okmsg">Found: ${j.count}. Showing unique: ${allResults.length}. Need more? add <b>?max=500</b> in URL.</div>`;
        } else {
          msg.innerHTML = `<div class="okmsg">${allResults.length} unique matches.</div>`;
        }
        currentPage = 1; renderPage();
        // Focus results and hide toast
        resultsEl.scrollIntoView({behavior:'smooth'});
        toast.classList.remove('show');
      }catch(err){
        console.error(err);
        msg.innerHTML = `<div class="error">Network/JSON error.</div>`;
        toast.classList.remove('show');
      }
    };

    /* ---------- Lightbox ---------- */
    let lbIndex = -1;
    const lightbox = document.getElementById('lightbox');
    const lightImg = document.getElementById('lightImg');
    const lbClose  = document.getElementById('lbClose');
    const lbPrev   = document.getElementById('lbPrev');
    const lbNext   = document.getElementById('lbNext');

    function openLightbox(globalIdx){ lbIndex = globalIdx; updateLightbox(); lightbox.classList.add('show'); }
    function closeLightbox(){ lightbox.classList.remove('show'); lightImg.src = ""; }
    function updateLightbox(){ const item = allResults[lbIndex]; if (!item){ closeLightbox(); return; } lightImg.src = item.downloadUrl || ""; }
    function step(delta){ const total = allResults.length; if (!total) return; lbIndex = (lbIndex + delta + total) % total; updateLightbox(); }

    lbClose.onclick = closeLightbox;
    lbPrev.onclick = ()=> step(-1);
    lbNext.onclick = ()=> step(+1);
    lightbox.addEventListener('click',(e)=>{ if(e.target===lightbox) closeLightbox(); });
    window.addEventListener('keydown',(e)=>{ if(!lightbox.classList.contains('show')) return; if(e.key==='Escape') closeLightbox(); if(e.key==='ArrowLeft') step(-1); if(e.key==='ArrowRight') step(+1); });

    // init: auto-open camera when possible
    (function(){ startCam(); })();
  </script>
</body>
</html>
