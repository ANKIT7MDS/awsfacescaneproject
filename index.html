<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Selfie Search – BJP Mandsaur</title>
  <style>
    :root {
      --bg:#0e1420; --panel:#111a28; --muted:#7b8aa5; --text:#e9eef7;
      --brand:#ff7a00; --chip:#243048; --chipText:#cfe1ff;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:36px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 14px}
    button{background:var(--brand);color:#111;padding:10px 18px;border:0;border-radius:10px;
      font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:var(--chip);color:var(--chipText);padding:4px 10px;border-radius:999px;font-size:12px}
    .imgbox{display:grid;place-items:center;background:#0a1020;border-radius:12px;height:360px;overflow:hidden}
    .imgbox img, .imgbox video{max-width:100%;max-height:100%;object-fit:contain}
    input[type=file]{background:#0b1424;border:1px solid #1f2a3f;color:var(--text);padding:10px;border-radius:10px;width:100%}
    .result{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumb{background:#0a1020;border-radius:10px;padding:8px}
    .thumb img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .api{background:#0b1424;border:1px dashed #243148;border-radius:10px;padding:8px 10px;font-size:12px;overflow:auto}
  </style>
</head>
<body>
<div class="wrap">

  <div class="grid">
    <!-- Left: Capture/Select -->
    <div class="card">
      <h1>फोटो चुनें या कैमरा से कैप्चर करें</h1>

      <div class="imgbox" id="previewBox">
        <img id="preview" alt="preview" style="display:none"/>
        <video id="video" autoplay playsinline style="display:none"></video>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="startBtn">कैमरा चालू करें</button>
        <button id="snapBtn">कैप्चर करें</button>
        <button id="stopBtn">बंद करें</button>
      </div>

      <div style="margin-top:12px">
        <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />
        <div class="muted" style="margin-top:6px">* अगर कैमरा ना मिले, ब्राउज़र/डिवाइस अनुमति दें।</div>
      </div>
    </div>

    <!-- Right: Selected + Search -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h1>चुना गया फोटो <span class="muted">(latest)</span></h1>
        <span class="pill">folder: <span id="folderChip">link</span></span>
      </div>

      <div class="imgbox" id="selectedBox">
        <img id="selected" alt="selected" style="display:none"/>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="searchBtn">सर्च करें</button>
        <button id="clearBtn">हटाएँ</button>
      </div>

      <div class="muted" style="margin-top:10px">API:</div>
      <div class="api" id="apiEcho"></div>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <h1>रिज़ल्ट</h1>
    <div id="results" class="result"></div>
    <div class="muted" id="noresult" style="margin-top:8px">कोई मिलान नहीं मिला।</div>
  </div>

</div>

<!-- ========= CONFIG (यहाँ भरें) ========= -->
<script>
/**
 * EDIT: अपने values डालें
 * BASE → आपका API Gateway stage का base (resource /search सहित)
 * LINK_ID → अगर sharable link मोड चाहिए, तो permanent linkId यहाँ दें
 * DEFAULT_FOLDER → जब LINK_ID empty हो, उस folder में search हो
 */
window.API = {
  BASE: "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search", // EDIT
  LINK_ID: "3ff7e052ee37",                       // e.g. "3ff7e052ee37"  (या URL ?link= से दें)
  DEFAULT_FOLDER: "common",          // जब LINK_ID खाली हो
  THRESHOLD: 60,
  MAX_RESULTS: 20
};
</script>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // BASE pick + trailing slash हटाओ + कभी भी /search/search न बने
  const BASE = (qs.get("base") || (window.API && window.API.BASE) || "").replace(/\/+$/,"");
  if(!BASE){ alert("API BASE कॉन्फ़िग नहीं है."); return; }
  document.getElementById("apiEcho").textContent = BASE;

  // लिंक/फोल्डर मोड तय करो
  const LINK_ID = (qs.get("link") || (window.API && window.API.LINK_ID) || "").trim();
  const DEFAULT_FOLDER = (qs.get("folder") || (window.API && window.API.DEFAULT_FOLDER) || "common").trim();
  document.getElementById("folderChip").textContent = LINK_ID ? "link" : DEFAULT_FOLDER;

  const THRESHOLD = Number(qs.get("threshold")) || (window.API && window.API.THRESHOLD) || 60;
  const MAX_RESULTS = Number(qs.get("max")) || (window.API && window.API.MAX_RESULTS) || 20;

  // DOM
  const file = document.getElementById('file');
  const preview = document.getElementById('preview');
  const selected = document.getElementById('selected');
  const video = document.getElementById('video');
  const results = document.getElementById('results');
  const noresult = document.getElementById('noresult');

  let stream=null, lastDataUrl="";

  function setSelected(src){
    selected.src = src; selected.style.display="block";
    preview.style.display = "none";
    lastDataUrl = src;
  }

  // file choose
  file.addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const buf = await f.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const mime = f.type || "image/jpeg";
    setSelected(`data:${mime};base64,${b64}`);
  });

  // camera controls
  document.getElementById('startBtn').onclick = async ()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
      video.srcObject = stream; video.style.display="block";
      preview.style.display="none";
      selected.style.display="none";
    }catch(e){ alert("कैमरा चालू नहीं हो पाया।"); }
  };
  document.getElementById('snapBtn').onclick = ()=>{
    if(!video.srcObject){ alert("पहले कैमरा चालू करें"); return; }
    const c = document.createElement('canvas');
    c.width = video.videoWidth; c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    setSelected(c.toDataURL("image/jpeg",0.92));
  };
  document.getElementById('stopBtn').onclick = ()=>{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.style.display="none";
  };

  document.getElementById('clearBtn').onclick = ()=>{
    selected.removeAttribute('src'); selected.style.display="none";
    lastDataUrl="";
  };

  // Search
  document.getElementById('searchBtn').onclick = async ()=>{
    try{
      if(!lastDataUrl){ alert("कृपया फोटो चुनें/कैप्चर करें"); return; }

      // payload: LINK_ID हो तो वही भेजो; नहीं तो allowedFolders
      const body = {
        imageBase64: lastDataUrl,
        threshold: THRESHOLD,
        maxResults: MAX_RESULTS
      };
      if(LINK_ID){
        body.linkId = LINK_ID;
      }else{
        body.allowedFolders = [DEFAULT_FOLDER];
      }

      // NOTE: BASE पहले से /search stage है, इसलिए यही call करें
      const r = await fetch(`${BASE}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await r.json().catch(()=>({}));
      renderResults(j);
    }catch(err){
      console.error(err);
      alert("सर्च में समस्या आई। Console देखें।");
    }
  };

  function renderResults(j){
    results.innerHTML="";
    const arr = Array.isArray(j?.results) ? j.results : [];
    if(!arr.length){ noresult.style.display="block"; return; }
    noresult.style.display="none";
    arr.forEach(x=>{
      const div = document.createElement('div'); div.className="thumb";
      const img = document.createElement('img'); img.src = x.downloadUrl || x.url || "";
      const cap = document.createElement('div');
      cap.className="muted"; cap.style.marginTop="6px";
      cap.textContent = `${Math.round((x.similarity||0))}%`;
      div.appendChild(img); div.appendChild(cap);
      results.appendChild(div);
    });
  }
})();
</script>
</body>
</html>
