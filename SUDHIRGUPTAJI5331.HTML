<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Selfie Search ‚Ä¢ Admin Uploader (sudhirji)</title>
<meta name="robots" content="noindex,nofollow">
<style>
  :root{--bg:#0b0d10;--card:#12151a;--muted:#97a3b6;--brand:#f97316;--text:#edf2f7;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .row{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid #1b2130;border-radius:18px;padding:16px}
  .btn{background:var(--brand);color:#1b0a00;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#0000;border:1px solid #293142;color:var(--text)}
  .muted{color:var(--muted)}
  .head{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:#0e1625;border:1px solid #20304a;color:#b6c3d9;font-size:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.grid2{grid-template-columns:1fr}}
  .drop{border:2px dashed #2a364d;border-radius:16px;padding:16px;text-align:center;background:#0f1522}
  .drop.over{border-color:var(--brand);background:#121a2b}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .item{background:#0e141f;border:1px solid #1b2335;border-radius:14px;padding:10px;display:flex;gap:10px;align-items:center}
  .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid #233145;background:#0c111b}
  progress{width:100%}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #1d2740;background:#0e1625;margin-right:6px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
</style>
</head>
<body>

<div class="wrap" id="app">
  <div class="row">
    <div class="card head">
      <div class="badges">
        <div class="badge">Admin Uploader</div>
        <div class="badge">API: <span id="apiState">checking‚Ä¶</span></div>
        <div class="badge">Folder: <b>sudhirji</b></div>
        <div class="badge">Session ‚Ä¢ <span id="sCount">0</span> files</div>
      </div>
      <div class="muted">Any format accepted ‚Ä¢ auto-convert to JPEG ‚Ä¢ duplicate auto-skip (server)</div>
    </div>

    <div class="grid2">
      <div class="card">
        <h3 style="margin:0 0 8px">‚¨ÜÔ∏è Upload to <code>sudhirji</code></h3>

        <div id="drop" class="drop">
          <div style="font-size:22px;margin-bottom:6px">Drag & Drop files here</div>
          <div class="muted">or</div>
          <div style="margin-top:6px">
            <input id="pick" type="file" accept="image/*" multiple />
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="start" class="btn">Start Upload</button>
          <button id="clear" class="btn ghost">Clear List</button>
          <span class="pill">Queued: <b id="q">0</b></span>
          <span class="pill ok">OK: <b id="ok">0</b></span>
          <span class="pill warn">Duplicate: <b id="dup">0</b></span>
          <span class="pill err">Failed: <b id="fail">0</b></span>
        </div>

        <div style="margin-top:10px">
          <progress id="bar" max="100" value="0"></progress>
          <div id="progMsg" class="muted" style="margin-top:6px"></div>
          <div id="note" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">üìã Queue</h3>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== FIXED CONFIG ===== */
const API_BASE = "https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search";
const URLS = { health: `${API_BASE}/health`, upload: `${API_BASE}/admin/upload` };
const FOLDER_ID = "sudhirji";
const ADMIN_TOKEN = "ChangeMe_Secret_123"; // <- hard-coded token

/* ===== Helpers ===== */
const el = id => document.getElementById(id);

/* Health check (info only) */
(async () => {
  try { const r=await fetch(URLS.health); const j=await r.json(); el('apiState').textContent = j.ok? 'OK':'error'; }
  catch { el('apiState').textContent = 'error'; }
})();

/* Drag & Drop / Picker */
const drop = el('drop');
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.add('over');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.remove('over');}));
drop.addEventListener('drop', e=> addToQueue([...(e.dataTransfer?.files||[])]) );
el('pick').addEventListener('change', e=>{ addToQueue([...(e.target.files||[])]); e.target.value=''; });

el('start').onclick = startUpload;
el('clear').onclick = clearQueue;

/* Queue state */
const queue=[]; let ok=0,dup=0,fail=0,done=0;

function addToQueue(files){
  files.forEach(f=>{
    const u = URL.createObjectURL(f);
    queue.push({file:f, url:u, state:'waiting', note:''});
  });
  renderQueue();
}
function clearQueue(){
  queue.forEach(it=>URL.revokeObjectURL(it.url));
  queue.length=0; ok=dup=fail=done=0;
  el('bar').value=0; el('progMsg').textContent=''; el('note').textContent='';
  renderQueue();
}
function renderQueue(){
  el('q').textContent = queue.length - done;
  el('ok').textContent = ok;
  el('dup').textContent = dup;
  el('fail').textContent = fail;
  el('sCount').textContent = done;

  const list = el('list'); list.innerHTML='';
  queue.forEach(it=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `
      <img class="thumb" src="${it.url}" alt="">
      <div style="flex:1">
        <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${it.file.name}</div>
        <div class="muted" style="font-size:12px;margin:3px 0">${it.state}${it.note? ' ‚Ä¢ '+it.note:''}</div>
      </div>`;
    list.appendChild(div);
  });
}

/* Any ‚Üí JPEG */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
async function toJPEG(file){
  const dataUrl = await fileToDataURL(file);
  const img = new Image(); img.crossOrigin='anonymous';
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataUrl; });
  const maxSide=1600, s=Math.min(1, maxSide/Math.max(img.width,img.height));
  const W=Math.max(1,Math.round(img.width*s)), H=Math.max(1,Math.round(img.height*s));
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  c.getContext('2d').drawImage(img,0,0,W,H);
  return c.toDataURL('image/jpeg',0.92);
}

/* Always send Authorization header */
function authHeaders(){
  return {
    "Content-Type":"application/json",
    "Authorization": "Bearer " + ADMIN_TOKEN
  };
}

/* Upload (3 parallel) */
async function startUpload(){
  if(queue.length===0){ alert('Add some files first'); return; }
  el('bar').value=0; ok=dup=fail=done=0; renderQueue();

  const MAX_CONC=3; let idx=0, active=0;
  await new Promise(resolve=>{
    const next=()=>{
      if(idx>=queue.length && active===0) return resolve();
      while(active<MAX_CONC && idx<queue.length){
        const cur = queue[idx++]; active++;
        handleOne(cur).finally(()=>{
          active--;
          el('bar').value = Math.round((done/queue.length)*100);
          el('progMsg').textContent = `${done}/${queue.length}`;
          renderQueue();
          next();
        });
      }
    };
    next();
  });
}

async function handleOne(item){
  try{
    item.state='converting'; renderQueue();
    const jpeg = await toJPEG(item.file);

    item.state='uploading'; renderQueue();
    const r = await fetch(URLS.upload, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify({ folderId: FOLDER_ID, imageBase64: jpeg })
    });

    let j={}; try{ j = await r.json(); }catch(_){}
    if(r.status===401){
      fail++; item.state='error'; item.note='401 Unauthorized (token mismatch)';
      el('note').textContent='‚ö†Ô∏è Server ‡§®‡•á 401 ‡§¶‡§ø‡§Ø‡§æ‚ÄîAuthorization token ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç ‡§Ø‡§æ CORS headers ‡§∏‡§π‡•Ä ‡§ï‡§∞‡•á‡§Ç.';
    }else if(j.duplicate){
      dup++; item.state='done'; item.note='duplicate';
    }else if(j.ok){
      ok++; item.state='done'; item.note='ok';
    }else if(!r.ok){
      fail++; item.state='error'; item.note=j.error||r.statusText;
    }else{
      ok++; item.state='done'; item.note='ok';
    }
  }catch(e){
    fail++; item.state='error'; item.note=String(e.message||e);
  }finally{
    done++;
  }
}
</script>
</body>
</html>
